<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction • simaerep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">simaerep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/intro.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/intro.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/classic.html">Classic Algorithm</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/simaerep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/simaerep/blob/HEAD/vignettes/intro.Rmd" class="external-link"><code>vignettes/intro.Rmd</code></a></small>
      <div class="d-none name"><code>intro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="load">Load<a class="anchor" aria-label="anchor" href="#load"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/simaerep/">simaerep</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Simulate subject-level event reporting of clinical trial sites with
the goal of detecting over- and under-reporting.</p>
<p>Monitoring reporting rates of subject-level clinical events (e.g.
adverse events, protocol deviations) reported by clinical trial sites is
an important aspect of risk-based quality monitoring (RBQM) strategy.
Sites that are under-reporting or over-reporting events can be detected
using bootstrap simulations during which patients are redistributed
between sites. Site-specific distributions of event reporting rates are
generated that are used to assign probabilities to the observed
reporting rates.</p>
<p>The method is inspired by the ‘infer’ R package and Allen Downey’s
blog article: <a href="http://allendowney.blogspot.com/2011/05/there-is-only-one-test.html" class="external-link">“There
is only one test!”</a>.</p>
<div class="section level3">
<h3 id="why-use-simaerep">Why use {simaerep}?<a class="anchor" aria-label="anchor" href="#why-use-simaerep"></a>
</h3>
<p>Patient-level events during a clinical study do not occur randomly at
visits but they are heavily dependent on the underlying study protocol
and the planned procedures. We have illustrated this in our simulated
test data by sampling event rates from a gamma distribution with higher
rates for early visits and low rates for late visits.</p>
<p>Typically most RBQM tools calculate a ratio between the site event
count and the number of patient, the days that they spend on study or
the number of visits. Then they employ some outlier detection method to
detect outliers (e.g. box plot statistics, percentiles, funnel plots).
All of these methods assume a constant event rate over the course of the
study or that all patients started the trial at the same time.</p>
<p>In a simulation experiments we could show that {simaerep} outperforms
these methods <a href="https://openpharma.github.io/simaerep/articles/funnel_perf.html">see
documentation</a>.</p>
<p>{simaerep} has also been positively evaluated by three different
industry members for the purpose of detecting sites that are
under-reporting adverse events <a href="https://doi.org/10.1007/s40264-020-01011-5" class="external-link">Koneswarakantha et
al. 2024</a>.</p>
</div>
<div class="section level3">
<h3 id="algorithm">Algorithm<a class="anchor" aria-label="anchor" href="#algorithm"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Record initial site-level events per visits rate</li>
<li>Replace every patient with a random patient with the same number of
visits</li>
<li>Record site-level events per visits rate for new set of
patients</li>
<li>Repeat 3) 1000 times to obtain site-specific events per visits rate
distribution.</li>
<li>Determine probability to obtain initial site-level events per visits
rate from 1) using the distribution generated in 4)</li>
<li>Adjust probabilities using the <a href="https://www.statisticshowto.com/benjamini-hochberg-procedure/" class="external-link">Benjamin
Hochberg Procedure</a> in order to correct alpha error.</li>
</ol>
</div>
<div class="section level3">
<h3 id="sample-data">Sample Data<a class="anchor" aria-label="anchor" href="#sample-data"></a>
</h3>
<div class="section level4">
<h4 id="patient">Patient<a class="anchor" aria-label="anchor" href="#patient"></a>
</h4>
<p>Patient level AE data is characterized by the number of consecutive
visits and the number of AEs that have been reported each time. For the
maximum consecutive visit we sample from a normal distribution and for
the AEs reported at each visit we sample from a poisson
distribution.</p>
<p>Here we simulate the AEs generated by 3 patients</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span></span>
<span>   <span class="fl">3</span>,</span>
<span>   <span class="fu"><a href="../reference/sim_test_data_patient.html">sim_test_data_patient</a></span><span class="op">(</span></span>
<span>    .f_sample_max_visit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">20</span>, sd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    .f_sample_event_per_visit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">max_visit</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">max_visit</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##  [1]  0  1  1  2  4  5  6  6  6  6  7  7  8  8  9 12 12</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##  [1] 0 1 1 1 1 1 1 2 2 2 2 2 2 3 4 5 5 6 6 7 8 9 9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##  [1] 0 0 1 2 2 3 3 3 3 3 3 3 4 4 6 6 6 6 7 7</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="study">Study<a class="anchor" aria-label="anchor" href="#study"></a>
</h4>
<p>In order to simulate patient data for an entire study we assume make
the simplification that all sites have the same number of patients.
Further we specify a fraction of sites that is under-reporting
events.</p>
<p>We sample event_rates from a gamma distribution to reflect the
non-constant event rates.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span></span>
<span>  n_pat <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of patients in study</span></span>
<span>  n_sites <span class="op">=</span> <span class="fl">10</span>, <span class="co"># number of sites in study</span></span>
<span>  ratio_out <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># ratio of sites with outlier</span></span>
<span>  factor_event_rate <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="co"># rate of under-reporting</span></span>
<span>  <span class="co"># non-constant event rates based on gamma distribution</span></span>
<span>  event_rates <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">0.5</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">5</span>, rate <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>,</span>
<span>  max_visit <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  max_visit_sd <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  study_id <span class="op">=</span> <span class="st">"A"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="11%">
<col width="8%">
<col width="7%">
<col width="15%">
<col width="13%">
<col width="21%">
<col width="6%">
<col width="8%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="left">patient_id</th>
<th align="left">site_id</th>
<th align="left">is_out</th>
<th align="right">max_visit_mean</th>
<th align="right">max_visit_sd</th>
<th align="right">event_per_visit_mean</th>
<th align="right">visit</th>
<th align="right">n_event</th>
<th align="left">study_id</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">5</td>
<td align="right">6</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">6</td>
<td align="right">7</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">8</td>
<td align="right">7</td>
<td align="left">A</td>
</tr>
<tr class="odd">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">9</td>
<td align="right">7</td>
<td align="left">A</td>
</tr>
<tr class="even">
<td align="left">P000001</td>
<td align="left">S0001</td>
<td align="left">TRUE</td>
<td align="right">20</td>
<td align="right">10</td>
<td align="right">0.1762578</td>
<td align="right">10</td>
<td align="right">7</td>
<td align="left">A</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_visit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">is_out</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">site_id</th>
<th align="left">is_out</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">TRUE</td>
</tr>
<tr class="even">
<td align="left">S0002</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">S0003</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">S0004</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">S0005</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">S0006</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">S0007</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">S0008</td>
<td align="left">FALSE</td>
</tr>
<tr class="odd">
<td align="left">S0009</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">S0010</td>
<td align="left">FALSE</td>
</tr>
</tbody>
</table>
<p>In our sample data 1 sites (S0001) is under-reporting events.</p>
</div>
</div>
<div class="section level3">
<h3 id="algorithm-execution">Algorithm Execution<a class="anchor" aria-label="anchor" href="#algorithm-execution"></a>
</h3>
<div class="section level4">
<h4 id="standard">Standard<a class="anchor" aria-label="anchor" href="#standard"></a>
</h4>
<p>The column <code>event_prob</code> contains the reporting probability
for each site as values between -1 and 1. Under- and over-reporting
probabilities are inversely related and have been combined into one
column. Negative values show high under-reporting, positive values
higher over-reporting.</p>
<p>The column <code>event_delta</code> shows the difference of events
expected minus the events reported.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evrep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span><span class="op">)</span></span>
<span><span class="va">evrep</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Number of sites: 10</span></span>
<span><span class="co">## Number of studies: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Multiplicity correction applied to "*_prob" columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">##    study_id site_id event_count event_per_visit_site visits n_pat</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0001            67                0.390    172    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0002            97                0.740    131    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0003           122                0.587    208    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0004           108                0.6      180    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0005           121                0.5      242    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0006           101                0.470    215    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0007           103                0.545    189    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008           105                0.559    188    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0009           119                0.601    198    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0010            99                0.471    210    10</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: event_per_visit_study &lt;dbl&gt;, event_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   event_delta &lt;dbl&gt;</span></span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">evrep</span>, study <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p><em>Left panel shows mean cumulative event reporting per site (blue
lines) against mean cumulative event reporting of the entire study
(golden line). Sites with either high under-reporting (negative
probabilities) or high over-reporting (positive probabilities) are
marked by grey dots and plotted in additional panels on the right. N
denotes the number of sites. Right panel shows individual sites with
total patient cumulative counts as grey lines. N denotes the number of
patients, the percentage the under- and over-reporting probability and
394 denotes the difference compared to the expected number of
events.</em></p>
</div>
<div class="section level4">
<h4 id="illustrate-probability-scoring">Illustrate Probability Scoring<a class="anchor" aria-label="anchor" href="#illustrate-probability-scoring"></a>
</h4>
<p>We can illustrate the probability scoring by increasing the number of
sites and switching off the multiplicity correction and not introducing
any outlier.</p>
<p>Note that none of these sites are actually outlier but high scores
are the results of repetitive testing.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span></span>
<span>  n_pat <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># number of patients in study</span></span>
<span>  n_sites <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of sites in study</span></span>
<span>  <span class="co"># non-constant event rates based on gamma distribution</span></span>
<span>  event_rates <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">0.5</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">5</span>, rate <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>,</span>
<span>  max_visit <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  max_visit_sd <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  study_id <span class="op">=</span> <span class="st">"A"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">evrep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span>, mult_corr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">evrep</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Number of sites: 100</span></span>
<span><span class="co">## Number of studies: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">##    study_id site_id event_count event_per_visit_site visits n_pat</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0001            95                0.426    223    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0002           116                0.547    212    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0003            97                0.424    229    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0004           110                0.509    216    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0005           109                0.623    175    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0006           115                0.5      230    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0007           103                0.518    199    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008           133                0.522    255    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0009           125                0.710    176    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0010           107                0.457    234    10</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: event_per_visit_study &lt;dbl&gt;, event_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   event_delta &lt;dbl&gt;</span></span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">evrep</span>, study <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="multiple-event-types">Multiple Event Types<a class="anchor" aria-label="anchor" href="#multiple-event-types"></a>
</h4>
<p>We can calculate scores for multiple event types in one go. This time
we add a site outlier with 50% over-reporting.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">event_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span></span>
<span>  n_pat <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># number of patients in study</span></span>
<span>  n_sites <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of sites in study</span></span>
<span>  <span class="co"># non-constant event rates based on gamma distribution</span></span>
<span>  ratio_out <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">100</span>, <span class="co"># ratio of sites with outlier</span></span>
<span>  factor_event_rate <span class="op">=</span> <span class="op">+</span><span class="fl">0.5</span>, <span class="co"># rate of over-reporting</span></span>
<span>  event_names <span class="op">=</span> <span class="va">event_names</span>,</span>
<span>  event_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">0.5</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">5</span>, rate <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>,</span>
<span>    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">0.5</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span></span>
<span>  <span class="op">)</span>,</span>
<span>  max_visit <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  max_visit_sd <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  study_id <span class="op">=</span> <span class="st">"A"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">patient_id</span>, <span class="va">visit</span>, <span class="va">n_x</span>, <span class="va">n_y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 19,535 × 5</span></span></span>
<span><span class="co">##    site_id patient_id visit   n_x   n_y</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> S0001   P000001        1     2     3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> S0001   P000001        2     7     7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> S0001   P000001        3     9    15</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> S0001   P000001        4    14    17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> S0001   P000001        5    19    19</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> S0001   P000001        6    21    21</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> S0001   P000001        7    22    21</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> S0001   P000001        8    22    21</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> S0001   P000001        9    22    21</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> S0001   P000001       10    22    21</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 19,525 more rows</span></span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evrep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span>, event_names <span class="op">=</span> <span class="va">event_names</span><span class="op">)</span></span>
<span><span class="va">evrep</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Number of sites: 100</span></span>
<span><span class="co">## Number of studies: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Multiplicity correction applied to "*_prob" columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Reporting probabilities calculated for: x, y </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 14</span></span></span>
<span><span class="co">##    study_id site_id x_count y_count x_per_visit_site y_per_visit_site visits</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0001       177     175            0.738            0.729    240</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0002       120      99            0.632            0.521    190</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0003       111      89            0.624            0.5      178</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0004       107     105            0.540            0.530    198</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0005        97      83            0.551            0.472    176</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0006       111      97            0.531            0.464    209</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0007       110     106            0.466            0.449    236</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008       119     116            0.482            0.470    247</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0009       121     103            0.680            0.579    178</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0010        92      82            0.561            0.5      164</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 7 more variables: n_pat &lt;int&gt;, x_per_visit_study &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   y_per_visit_study &lt;dbl&gt;, x_prob &lt;dbl&gt;, x_delta &lt;dbl&gt;, y_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   y_delta &lt;dbl&gt;</span></span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">evrep</span>, study <span class="op">=</span> <span class="st">"A"</span>, plot_event <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">evrep</span>, study <span class="op">=</span> <span class="st">"A"</span>, plot_event <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="input-data-requirements">Input Data Requirements<a class="anchor" aria-label="anchor" href="#input-data-requirements"></a>
</h4>
<p>As input data the cumulative event count for each patient visit is
required.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">patient_id</span> <span class="op">==</span> <span class="st">"P000001"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">patient_id</span>, <span class="va">visit</span>, <span class="va">n_event</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">site_id</th>
<th align="left">patient_id</th>
<th align="right">visit</th>
<th align="right">n_event</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">1</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">2</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">3</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">4</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">5</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">6</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">7</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">8</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">9</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">10</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">11</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">12</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">13</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">14</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">S0001</td>
<td align="left">P000001</td>
<td align="right">15</td>
<td align="right">12</td>
</tr>
</tbody>
</table>
<p>In practice this requires data from different domains within the
clinical data set to be merged. This requires the patient and site ids
as well as the date and time at which visits and events are
occurring.</p>
<p>There will be edge cases e.g. missing dates, missing patient link,
events and visits on the same date, that require attention.</p>
<p><a href="https://impala-consortium.github.io/gsm.simaerep/reference/Input_CumCount.html" class="external-link">gsm.simaerep::InputCumCount</a>
that is part of the gsm extension <a href="https://github.com/IMPALA-Consortium/gsm.simaerep" class="external-link"><code>gsm.simaerep</code></a>
uses subject, visit and event data as input and merges the data into a
<code>simaerep</code> ready data frame.</p>
<p>However, it follows the <code>gsm</code> naming conventions so the
column names will be different than those required by
<code>simaerep</code>. We can adapt to the different column names in the
following way.</p>
<p><code>gsm.simaerep</code> has not yet been released on CRAN so we are
not demonstrating it’s functionality here.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_visit_gsm</span> <span class="op">&lt;-</span> <span class="va">df_visit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    study_id <span class="op">=</span> <span class="st">"A"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    StudyID <span class="op">=</span> <span class="va">study_id</span>,</span>
<span>    GroupID <span class="op">=</span> <span class="va">site_id</span>,</span>
<span>    SubjectID <span class="op">=</span> <span class="va">patient_id</span>, </span>
<span>    Denominator <span class="op">=</span> <span class="va">visit</span>, </span>
<span>    Numerator <span class="op">=</span> <span class="va">n_event</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span></span>
<span>  <span class="va">df_visit_gsm</span>,</span>
<span>  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    study_id <span class="op">=</span> <span class="st">"StudyID"</span>,</span>
<span>    site_id <span class="op">=</span> <span class="st">"GroupID"</span>,</span>
<span>    patient_id <span class="op">=</span> <span class="st">"SubjectID"</span>,</span>
<span>    visit <span class="op">=</span> <span class="st">"Denominator"</span>,</span>
<span>    n_ae <span class="op">=</span> <span class="st">"Numerator"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Number of sites: 20</span></span>
<span><span class="co">## Number of studies: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Multiplicity correction applied to "*_prob" columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">##    StudyID GroupID ae_count ae_per_visit_site visits n_pat ae_per_visit_study</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A       S0001        511             0.512    998    50              0.502</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A       S0002        501             0.504    994    50              0.502</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A       S0003        513             0.515    996    50              0.504</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A       S0004        501             0.521    962    50              0.501</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A       S0005        476             0.504    945    50              0.503</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A       S0006        477             0.479    995    50              0.503</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A       S0007        520             0.513   <span style="text-decoration: underline;">1</span>013    50              0.506</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A       S0008        538             0.531   <span style="text-decoration: underline;">1</span>014    50              0.502</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A       S0009        447             0.468    956    50              0.503</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A       S0010        451             0.459    982    50              0.504</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2 more variables: ae_prob &lt;dbl&gt;, ae_delta &lt;dbl&gt;</span></span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="multiple-studies">Multiple Studies<a class="anchor" aria-label="anchor" href="#multiple-studies"></a>
</h3>
<p><code>simaerep</code> probabilities can be calculated for multiple
studies at once.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span>study_id <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span>study_id <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Number of sites: 40</span></span>
<span><span class="co">## Number of studies: 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Multiplicity correction applied to "*_prob" columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">##    study_id site_id event_count event_per_visit_site visits n_pat</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0001           494                0.496    995    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0002           480                0.503    955    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0003           491                0.490   <span style="text-decoration: underline;">1</span>003    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0004           524                0.514   <span style="text-decoration: underline;">1</span>019    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0005           479                0.506    947    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0006           511                0.532    960    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0007           492                0.512    961    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008           499                0.519    961    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0009           499                0.519    962    50</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0010           498                0.515    967    50</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: event_per_visit_study &lt;dbl&gt;, event_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   event_delta &lt;dbl&gt;</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="in-database-calculation">In Database Calculation<a class="anchor" aria-label="anchor" href="#in-database-calculation"></a>
</h3>
<p>We can demonstrate the database-backend compatibility by using a
connection to a in memory <code>duckdb</code> database. In order to set
the number of replications we need to create a new table in our back-end
that has one column with as many rows as the desired replications.</p>
<p>A lazy reference to this table can then be passed to the
<code>r</code> parameter.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span><span class="va">df_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>rep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span></span>
<span>  n_pat <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of patients in study</span></span>
<span>  n_sites <span class="op">=</span> <span class="fl">10</span>, <span class="co"># number of sites in study</span></span>
<span>  ratio_out <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># ratio of sites with outlier</span></span>
<span>  factor_event_rate <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="co"># rate of under-reporting</span></span>
<span>  <span class="co"># non-constant event rates based on gamma distribution</span></span>
<span>  event_rates <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">0.5</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">5</span>, rate <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>,</span>
<span>  max_visit <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  max_visit_sd <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  study_id <span class="op">=</span> <span class="st">"A"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">df_visit</span>, <span class="st">"visit"</span><span class="op">)</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">df_r</span>, <span class="st">"r"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"visit"</span><span class="op">)</span></span>
<span><span class="va">tbl_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"r"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">evrep_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">tbl_visit</span>, r <span class="op">=</span> <span class="va">tbl_r</span><span class="op">)</span></span></code></pre></div>
<p>When inspecting <code>df_eval</code> we see that it is still a lazy
table object.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evrep_db</span></span></code></pre></div>
<pre><code><span><span class="co">## simaerep object:</span></span>
<span><span class="co">## ----------------</span></span>
<span><span class="co">## Plot results using plot() generic.</span></span>
<span><span class="co">## Full results available in "df_eval".</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary:</span></span>
<span><span class="co">## Multiplicity correction applied to "*_prob" columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## First 10 rows of df_eval:</span></span>
<span><span class="co">## <span style="color: #949494;"># Source:     SQL [?? x 9]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Database:   DuckDB v1.3.0 [koneswab@Darwin 23.6.0:R 4.4.1/:memory:]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Ordered by: study_id, site_id</span></span></span>
<span><span class="co">##    study_id site_id event_count event_per_visit_site visits n_pat</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0006           119                0.463    257    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0007           122                0.552    221    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0004           116                0.483    240    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0001            61                0.302    202    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0003           125                0.595    210    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0002           105                0.544    193    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0009           123                0.530    232    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008           103                0.462    223    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0010           107                0.480    223    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0005            96                0.381    252    10</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: event_per_visit_study &lt;dbl&gt;, event_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   event_delta &lt;dbl&gt;</span></span></span></code></pre>
<p>We can convert it to sql code. The <code>cte</code> option makes the
sql code more readable.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_eval</span> <span class="op">&lt;-</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="va">evrep_db</span><span class="op">$</span><span class="va">df_eval</span>, sql_options <span class="op">=</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_options.html" class="external-link">sql_options</a></span><span class="op">(</span>cte <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html" class="external-link">str_trunc</a></span><span class="op">(</span><span class="va">sql_eval</span>, <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;SQL&gt; WITH q01 AS (</span></span>
<span><span class="co">##   SELECT</span></span>
<span><span class="co">##     patient_id AS patnum,</span></span>
<span><span class="co">##     site_id AS site_number,</span></span>
<span><span class="co">##     is_out,</span></span>
<span><span class="co">##     max_visit_mean,</span></span>
<span><span class="co">##     max_visit_sd,</span></span>
<span><span class="co">##     event_per_visit_mean,</span></span>
<span><span class="co">##     visit,</span></span>
<span><span class="co">##     n_event,</span></span>
<span><span class="co">##     study_id</span></span>
<span><span class="co">##   FROM visit</span></span>
<span><span class="co">## ),</span></span>
<span><span class="co">## q02 AS (</span></span>
<span><span class="co">##   SELECT</span></span>
<span><span class="co">##     patnum,</span></span>
<span><span class="co">##     site_number,</span></span>
<span><span class="co">##     is_out,</span></span>
<span><span class="co">##     max_visit_mean,</span></span>
<span><span class="co">##     max_visit_sd,</span></span>
<span><span class="co">##     event_per_visit_mean,</span></span>
<span><span class="co">##     CAST(visit AS NUMERIC) AS visit,</span></span>
<span><span class="co">##     CAST(n_event AS NUMERIC) AS n_event,</span></span>
<span><span class="co">##     study_id</span></span>
<span><span class="co">##   FROM q01</span></span>
<span><span class="co">## ),</span></span>
<span><span class="co">## q03 AS (</span></span>
<span><span class="co">##   SELECT DISTINCT study_id, site_number</span></span>
<span><span class="co">##   FROM q02 q01...</span></span></code></pre>
<p>We can take that code and wrap it in a <code>CREATE TABLE</code>
statement</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_create</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"CREATE TABLE eval AS ({sql_eval})"</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql_create</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10</span></span></code></pre>
<p>Retrieve the new table from the database.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"eval"</span><span class="op">)</span></span>
<span><span class="va">tbl_eval</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># Source:   table&lt;eval&gt; [?? x 9]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Database: DuckDB v1.3.0 [koneswab@Darwin 23.6.0:R 4.4.1/:memory:]</span></span></span>
<span><span class="co">##    study_id site_id event_count event_per_visit_site visits n_pat</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0003           125                0.595    210    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0005            96                0.381    252    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0001            61                0.302    202    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0009           123                0.530    232    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0008           103                0.462    223    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0004           116                0.483    240    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0010           107                0.480    223    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0006           119                0.463    257    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0002           105                0.544    193    10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0007           122                0.552    221    10</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: event_per_visit_study &lt;dbl&gt;, event_prob &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   event_delta &lt;dbl&gt;</span></span></span></code></pre>
<p>We plot the results from the {simaerep} object.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">evrep_db</span>, study <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
