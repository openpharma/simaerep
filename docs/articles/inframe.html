<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inframe Simulation Using Table Operations • simaerep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Inframe Simulation Using Table Operations">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simaerep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/intro.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/sas_files.html">SAS Files as a Data Source</a>
    </li>
    <li>
      <a href="../articles/portfolio_perf.html">simaerep Portfolio Performance</a>
    </li>
    <li>
      <a href="../articles/visit_med75.html">Adjusted Evaluation Point visit_med75</a>
    </li>
    <li>
      <a href="../articles/usability_limits.html">Address Usability Limits of Bootstrap Method</a>
    </li>
    <li>
      <a href="../articles/check_poisson.html">Check Poisson Test Applicability</a>
    </li>
    <li>
      <a href="../articles/visits_or_days.html">Aggregate AEs by Days or Visit?</a>
    </li>
    <li>
      <a href="../articles/gsm_perf.html">Comparing {simaerep} and {gsm} Performance</a>
    </li>
    <li>
      <a href="../articles/over.html">Over-Reporting Probability</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/openpharma/simaerep/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Inframe Simulation Using Table Operations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/simaerep/blob/HEAD/vignettes/inframe.Rmd" class="external-link"><code>vignettes/inframe.Rmd</code></a></small>
      <div class="hidden name"><code>inframe.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="load">Load<a class="anchor" aria-label="anchor" href="#load"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/simaerep/">simaerep</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>With the latest <code>0.6.0</code> release we have added an
alternative version of the {simaerep} algorithm that was coded using
solely <code>dbplyr</code> compatible table operations.</p>
<ul>
<li>expand the patients for each site <code>r</code> times</li>
<li>join each patient with a random eligible patient from same
study</li>
<li>for each replicate calculate event per visit rate per site</li>
<li>calculate the ratio of having a lower event per visit rate than
actually observed</li>
</ul>
<p>This comes with the following advantages and disadvantages:</p>
<ul>
<li>Patients are individually matched with patients that have reached
the same visit in the study. No need to pick visit_med75 as an
evaluation point.</li>
<li>
<code>dbplyr</code> compatibility means that code execution can be
done in a database back-end as opposed to in-memory.</li>
<li>Matching patients individually is more costly, this increases
in-memory computation time</li>
<li>Limited patient sample pool for patients that have more visits than
other patients in study.</li>
</ul>
</div>
<div class="section level2">
<h2 id="sample-data">Sample Data<a class="anchor" aria-label="anchor" href="#sample-data"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span></span>
<span>  n_pat <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># number of patients in study</span></span>
<span>  n_sites <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of sites in study</span></span>
<span>  frac_site_with_ur <span class="op">=</span> <span class="fl">0.05</span>, <span class="co"># fraction of sites under-reporting</span></span>
<span>  ur_rate <span class="op">=</span> <span class="fl">0.4</span>, <span class="co"># rate of under-reporting</span></span>
<span>  ae_per_visit_mean <span class="op">=</span> <span class="fl">0.5</span> <span class="co"># mean AE per patient visit</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_visit</span><span class="op">$</span><span class="va">study_id</span> <span class="op">&lt;-</span> <span class="st">"A"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="patient-level-matching">Patient-Level Matching<a class="anchor" aria-label="anchor" href="#patient-level-matching"></a>
</h2>
<p>Here we use the standard version of the algorithm.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aerep_trad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aerep_trad</span><span class="op">)</span></span></code></pre></div>
<p><img src="inframe_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>To use the patient-level matching algorithm we set
<code>inframe=TRUE</code> and <code>visit_med75=FALSE</code>.</p>
<p>The original algorithm uses fixed seeds before sampling while the
inframe method does not. In order to obtain consistent results we need
to manually set a seed.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aerep_inframe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span></span>
<span>  <span class="va">df_visit</span>,</span>
<span>  inframe <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  visit_med75 <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The plot shows that for all sites 10/10 patients were used and none
were excluded. We also observe that the site average has become more
noisy as less patients are used to calculate the averages for the higher
visit numbers.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aerep_inframe</span><span class="op">)</span></span></code></pre></div>
<p><img src="inframe_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The inframe method includes this noisier data but does not compare
average event counts but event per visit rates. We can find
<code>events_per_visit_site</code> and
<code>events_per_visit_study</code> in <code>df_eval</code>. The latter
is the average event rate obtained in the simulation in which each
patient has been resampled according to its maximum visit.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aerep_inframe</span><span class="op">$</span><span class="va">df_eval</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 100 × 10</span></span></span>
<span><span class="co">##    study_id site_number events_per_visit_site events visits n_pat prob_low</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0001                       0.279     50    179    10    0    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0002                       0.281     59    210    10    0    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0003                       0.291     55    189    10    0    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0004                       0.312     59    189    10    0    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0005                       0.297     58    195    10    0    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0006                       0.493    100    203    10    0.569</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0007                       0.408     89    218    10    0.044</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0008                       0.559     95    170    10    0.922</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0009                       0.518    101    195    10    0.761</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0010                       0.470     87    185    10    0.385</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 90 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: events_per_visit_study &lt;dbl&gt;, prob_low_adj &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   prob_low_prob_ur &lt;dbl&gt;</span></span></span></code></pre>
<p>We can also force the inframe method to use the visit_med75 this will
prefilter <code>df_visit</code>, which adds an extra step and decreases
performance.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aerep_inframe_visit_med75</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span></span>
<span>  <span class="va">df_visit</span>,</span>
<span>  inframe <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  visit_med75 <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aerep_inframe_visit_med75</span><span class="op">)</span></span></code></pre></div>
<p><img src="inframe_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="db">DB<a class="anchor" aria-label="anchor" href="#db"></a>
</h2>
<p>We can demonstrate the database-backend compatibility by using a
connection to a in memory <code>duckdb</code> database. In order to set
the number of replications we need to create a new table in our back-end
that has one column with as many rows as the desired replications.</p>
<p>A lazy reference to this table can then be passed to the
<code>r</code> parameter.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span><span class="va">df_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>rep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">df_visit</span>, <span class="st">"visit"</span><span class="op">)</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">df_r</span>, <span class="st">"r"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"visit"</span><span class="op">)</span></span>
<span><span class="va">tbl_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"r"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">aerep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">tbl_visit</span>, r <span class="op">=</span> <span class="va">tbl_r</span>, visit_med75 <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>When inspecting <code>df_eval</code> we see that it is still a lazy
table object.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aerep</span><span class="op">$</span><span class="va">df_eval</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># Source:     SQL [?? x 10]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Database:   DuckDB v1.0.0 [koneswab@Darwin 23.4.0:R 4.4.1/:memory:]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Ordered by: study_id, site_number</span></span></span>
<span><span class="co">##    study_id site_number events_per_visit_site events visits n_pat prob_low</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0016                       0.489     90    184    10    0.499</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0011                       0.441     89    202    10    0.195</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0086                       0.492     96    195    10    0.543</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0057                       0.497     94    189    10    0.567</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0028                       0.5       95    190    10    0.586</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0014                       0.505    103    204    10    0.619</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0053                       0.502    102    203    10    0.65 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0018                       0.543    113    208    10    0.77 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0023                       0.531    104    196    10    0.81 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0056                       0.584    108    185    10    0.966</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: events_per_visit_study &lt;dbl&gt;, prob_low_adj &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   prob_low_prob_ur &lt;dbl&gt;</span></span></span></code></pre>
<p>We can convert it to sql code. The <code>cte</code> option makes the
sql code more readable.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_eval</span> <span class="op">&lt;-</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="va">aerep</span><span class="op">$</span><span class="va">df_eval</span>, sql_options <span class="op">=</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_options.html" class="external-link">sql_options</a></span><span class="op">(</span>cte <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html" class="external-link">str_trunc</a></span><span class="op">(</span><span class="va">sql_eval</span>, <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;SQL&gt; WITH q01 AS (</span></span>
<span><span class="co">##   SELECT DISTINCT study_id, site_number</span></span>
<span><span class="co">##   FROM visit</span></span>
<span><span class="co">## ),</span></span>
<span><span class="co">## q02 AS (</span></span>
<span><span class="co">##   SELECT</span></span>
<span><span class="co">##     patnum,</span></span>
<span><span class="co">##     site_number,</span></span>
<span><span class="co">##     is_ur,</span></span>
<span><span class="co">##     max_visit_mean,</span></span>
<span><span class="co">##     max_visit_sd,</span></span>
<span><span class="co">##     ae_per_visit_mean,</span></span>
<span><span class="co">##     CAST(visit AS NUMERIC) AS visit,</span></span>
<span><span class="co">##     CAST(n_ae AS NUMERIC) AS n_ae,</span></span>
<span><span class="co">##     study_id</span></span>
<span><span class="co">##   FROM visit</span></span>
<span><span class="co">## ),</span></span>
<span><span class="co">## q03 AS (</span></span>
<span><span class="co">##   SELECT study_id, site_number, patnum, MAX(visit) AS max_visit_per_pat</span></span>
<span><span class="co">##   FROM q02 q01</span></span>
<span><span class="co">##   GROUP BY study_id, site_number, patnum</span></span>
<span><span class="co">## ),</span></span>
<span><span class="co">## q04 AS (</span></span>
<span><span class="co">##   SELECT DISTINCT study_id, MAX(visit) AS visit</span></span>
<span><span class="co">##   FROM q02...</span></span></code></pre>
<p>We can take that code and wrap it in a <code>CREATE TABLE</code>
statement</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_create</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"CREATE TABLE eval AS ({sql_eval})"</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql_create</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100</span></span></code></pre>
<p>Retrieve the new table from the database.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"eval"</span><span class="op">)</span></span>
<span><span class="va">tbl_eval</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># Source:   table&lt;eval&gt; [?? x 10]</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Database: DuckDB v1.0.0 [koneswab@Darwin 23.4.0:R 4.4.1/:memory:]</span></span></span>
<span><span class="co">##    study_id site_number events_per_visit_site events visits n_pat prob_low</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> A        S0037                       0.429     85    198    10    0.128</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> A        S0067                       0.428     83    194    10    0.129</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> A        S0098                       0.490     96    196    10    0.527</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> A        S0085                       0.505    102    202    10    0.623</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> A        S0045                       0.510     98    192    10    0.661</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> A        S0017                       0.521     98    188    10    0.738</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> A        S0100                       0.556    104    187    10    0.888</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> A        S0007                       0.408     89    218    10    0.043</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> A        S0086                       0.492     96    195    10    0.552</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> A        S0006                       0.493    100    203    10    0.564</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 3 more variables: events_per_visit_study &lt;dbl&gt;, prob_low_adj &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   prob_low_prob_ur &lt;dbl&gt;</span></span></span></code></pre>
<p>We plot the results from the {simaerep} object.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aerep</span><span class="op">)</span></span></code></pre></div>
<p><img src="inframe_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Or more efficiently by using <code><a href="../reference/plot_study.html">plot_study()</a></code> when we have
already written the <code>simaerep</code> results into the database.
Here we avoid that the results are being recalculated just for the sake
of creating a plot. However this requires that we save
<code>df_site</code> to the database as well.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_site</span> <span class="op">&lt;-</span> <span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="va">aerep</span><span class="op">$</span><span class="va">df_site</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"CREATE TABLE site AS ({sql_site})"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"site"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_study.html">plot_study</a></span><span class="op">(</span><span class="va">tbl_visit</span>, <span class="va">tbl_site</span>, <span class="va">tbl_eval</span>, study <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inframe_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="in-memory-calculation-times">In Memory Calculation Times<a class="anchor" aria-label="anchor" href="#in-memory-calculation-times"></a>
</h2>
<p>Here we perform some examplary tests to illustrate the increase
in-memory calculation time of the inframe calculation method.</p>
<p>This is the calculation time for the default settings</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span>, inframe <span class="op">=</span> <span class="cn">FALSE</span>, visit_med75 <span class="op">=</span> <span class="cn">TRUE</span>, under_only <span class="op">=</span> <span class="cn">TRUE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   1.019   0.046   1.282</span></span></code></pre>
<p>inframe calculation time is higher</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="../reference/simaerep.html">simaerep</a></span><span class="op">(</span><span class="va">df_visit</span>, inframe <span class="op">=</span> <span class="cn">TRUE</span>, visit_med75 <span class="op">=</span> <span class="cn">FALSE</span>, under_only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   2.451   0.202   3.336</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
