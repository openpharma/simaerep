<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Address Usability Limits of Bootstrap Method â€¢ simaerep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Address Usability Limits of Bootstrap Method">
<meta property="og:description" content="simaerep">
<meta property="og:image" content="https://openpharma.github.io/simaerep/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simaerep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/intro.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/usability_limits.html">Address Usability Limits of Bootstrap Method</a>
    </li>
    <li>
      <a href="../articles/check_poisson.html">Check Poisson Test Applicability</a>
    </li>
    <li>
      <a href="../articles/sas_files.html">SAS Files as a Data Source</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/openpharma/simaerep/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="usability_limits_files/header-attrs-2.5/header-attrs.js"></script><link href="usability_limits_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="usability_limits_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Address Usability Limits of Bootstrap Method</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/simaerep/blob/master/vignettes/usability_limits.Rmd"><code>vignettes/usability_limits.Rmd</code></a></small>
      <div class="hidden name"><code>usability_limits.Rmd</code></div>

    </div>

    
    
<div id="load" class="section level1">
<h1 class="hasAnchor">
<a href="#load" class="anchor"></a>Load</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/future">future</a></span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/simaerep/">simaerep</a></span><span class="op">)</span> <span class="op">)</span></code></pre></div>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>As we already mentioned in the <a href="file:///git_repos/simaerep/docs/articles/intro.html#disadvantages-over-classic-statistical-tests">introduction</a> bootstrap resampling comes at a price. We need a good proportion of sites that are compliant and are not under-reporting AEs. Otherwise the patient pool we draw from will be tainted. Also, in general for count data, negative deviations from overall small integer values (3 or less) are hard to detect. Here we will assess the usability limits of the bootstrap resampling method by applying it to different simulated scenarios.</p>
</div>
<div id="parameter-grid" class="section level1">
<h1 class="hasAnchor">
<a href="#parameter-grid" class="anchor"></a>Parameter Grid</h1>
<p>We start by defining a parameter grid.</p>
<p><strong>Fixed Parameters:</strong><br>
- n_pat: 1000<br>
- n_sites: 100<br>
- max_visit_mean: 20<br>
- max_visit_sd: 4</p>
<p><strong>Variable Parameters:</strong><br>
- ae_visit: 0.05 - 2<br>
- frac_sites_wit_ur: 0.05 - 0.75<br>
- ur_rate: 0.05 - 1</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

<span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span> ae_per_visit_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">2</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>frac_site_with_ur <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.75</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">frac_site_with_ur</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>ur_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">ur_rate</span><span class="op">)</span> 

<span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 3
##    ae_per_visit_mean frac_site_with_ur ur_rate
##                &lt;dbl&gt;             &lt;dbl&gt;   &lt;dbl&gt;
##  1              0.05              0.05   0.05 
##  2              0.05              0.05   0.156
##  3              0.05              0.05   0.261
##  4              0.05              0.05   0.367
##  5              0.05              0.05   0.472
##  6              0.05              0.05   0.578
##  7              0.05              0.05   0.683
##  8              0.05              0.05   0.789
##  9              0.05              0.05   0.894
## 10              0.05              0.05   1    
## # â€¦ with 990 more rows</code></pre>
</div>
<div id="apply" class="section level1">
<h1 class="hasAnchor">
<a href="#apply" class="anchor"></a>Apply</h1>
<p>We use the <a href="https://github.com/DavisVaughan/furrr"><code>furrr</code></a> and the <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> package for multiprocessing. We proceed in applying all functions we already <a href="https://openpharma.github.io/simaerep/articles/intro.html">introduced</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">multiprocess</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="simulate-test-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-test-data" class="anchor"></a>Simulate Test Data</h2>
<p>We iteratively apply <a href="https://openpharma.github.io/simaerep/reference/sim_test_data_study.html">sim_test_data_study()</a> on the different parameter combination of the grid</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> 
    df_visit <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_pmap</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>am <span class="op">=</span> <span class="va">ae_per_visit_mean</span>,
           fr <span class="op">=</span> <span class="va">frac_site_with_ur</span>,
           ur <span class="op">=</span> <span class="va">ur_rate</span><span class="op">)</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">am</span>, <span class="va">fr</span>, <span class="va">ur</span><span class="op">)</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span>n_pat <span class="op">=</span> <span class="fl">1000</span>,
                                               n_sites <span class="op">=</span> <span class="fl">100</span>,
                                               max_visit_mean <span class="op">=</span> <span class="fl">20</span>,
                                               max_visit_sd <span class="op">=</span> <span class="fl">4</span>,
                                               ae_per_visit_mean <span class="op">=</span> <span class="va">am</span>,
                                               frac_site_with_ur <span class="op">=</span> <span class="va">fr</span>,
                                               ur_rate <span class="op">=</span> <span class="va">ur</span><span class="op">)</span>,
      .progress <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".

## Warning: UNRELIABLE VALUE: Future ('&lt;none&gt;') unexpectedly generated random
## numbers without specifying argument '[future.]seed'. There is a risk that those
## random numbers are not statistically sound and the overall results might be
## invalid. To fix this, specify argument '[future.]seed', e.g. 'seed=TRUE'. This
## ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-
## CMRG method. To disable this check, use [future].seed=NULL, or set option
## 'future.rng.onMisuse' to "ignore".</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 4
##    ae_per_visit_mean frac_site_with_ur ur_rate df_visit             
##                &lt;dbl&gt;             &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;               
##  1              0.05              0.05   0.05  &lt;tibble [19,363 Ã— 8]&gt;
##  2              0.05              0.05   0.156 &lt;tibble [19,396 Ã— 8]&gt;
##  3              0.05              0.05   0.261 &lt;tibble [19,623 Ã— 8]&gt;
##  4              0.05              0.05   0.367 &lt;tibble [19,483 Ã— 8]&gt;
##  5              0.05              0.05   0.472 &lt;tibble [19,700 Ã— 8]&gt;
##  6              0.05              0.05   0.578 &lt;tibble [19,546 Ã— 8]&gt;
##  7              0.05              0.05   0.683 &lt;tibble [19,401 Ã— 8]&gt;
##  8              0.05              0.05   0.789 &lt;tibble [19,469 Ã— 8]&gt;
##  9              0.05              0.05   0.894 &lt;tibble [19,142 Ã— 8]&gt;
## 10              0.05              0.05   1     &lt;tibble [19,525 Ã— 8]&gt;
## # â€¦ with 990 more rows</code></pre>
</div>
<div id="aggregate-test-data" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregate-test-data" class="anchor"></a>Aggregate Test Data</h2>
<p>We apply <a href="https://openpharma.github.io/simaerep/reference/site_aggr.html">site_aggr()</a> on the different simulated data sets.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> 
    df_visit <span class="op">=</span> <span class="fu">map2</span><span class="op">(</span><span class="va">df_visit</span>, <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span>,
                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">x</span>, study_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    df_site <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span><span class="va">df_visit</span>,
                                <span class="va">site_aggr</span>,
                                .progress <span class="op">=</span> <span class="cn">FALSE</span>,
                                .options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                                <span class="op">)</span>
  <span class="op">)</span>

<span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 5
##    ae_per_visit_mean frac_site_with_ur ur_rate df_visit          df_site        
##                &lt;dbl&gt;             &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;            &lt;list&gt;         
##  1              0.05              0.05   0.05  &lt;tibble [19,363 â€¦ &lt;tibble [100 Ã—â€¦
##  2              0.05              0.05   0.156 &lt;tibble [19,396 â€¦ &lt;tibble [100 Ã—â€¦
##  3              0.05              0.05   0.261 &lt;tibble [19,623 â€¦ &lt;tibble [100 Ã—â€¦
##  4              0.05              0.05   0.367 &lt;tibble [19,483 â€¦ &lt;tibble [100 Ã—â€¦
##  5              0.05              0.05   0.472 &lt;tibble [19,700 â€¦ &lt;tibble [100 Ã—â€¦
##  6              0.05              0.05   0.578 &lt;tibble [19,546 â€¦ &lt;tibble [100 Ã—â€¦
##  7              0.05              0.05   0.683 &lt;tibble [19,401 â€¦ &lt;tibble [100 Ã—â€¦
##  8              0.05              0.05   0.789 &lt;tibble [19,469 â€¦ &lt;tibble [100 Ã—â€¦
##  9              0.05              0.05   0.894 &lt;tibble [19,142 â€¦ &lt;tibble [100 Ã—â€¦
## 10              0.05              0.05   1     &lt;tibble [19,525 â€¦ &lt;tibble [100 Ã—â€¦
## # â€¦ with 990 more rows</code></pre>
</div>
<div id="simulate-sites" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-sites" class="anchor"></a>Simulate Sites</h2>
<p>We apply <a href="https://openpharma.github.io/simaerep/reference/sim_sites.html">sim_sites()</a> to to calculate the AE under-reporting probability.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> df_sim_sites <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_map2</a></span><span class="op">(</span><span class="va">df_site</span>, <span class="va">df_visit</span>,
                                            <span class="va">sim_sites</span>,
                                            r <span class="op">=</span> <span class="fl">1000</span>,
                                            poisson_test <span class="op">=</span> <span class="cn">TRUE</span>,
                                            prob_lower <span class="op">=</span> <span class="cn">TRUE</span>,
                                            .progress <span class="op">=</span> <span class="cn">FALSE</span>,
                                            .options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                                            <span class="op">)</span>
  <span class="op">)</span>

<span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 6
##    ae_per_visit_mean frac_site_with_â€¦ ur_rate df_visit   df_site   df_sim_sites 
##                &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;     &lt;list&gt;    &lt;list&gt;       
##  1              0.05             0.05   0.05  &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  2              0.05             0.05   0.156 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  3              0.05             0.05   0.261 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  4              0.05             0.05   0.367 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  5              0.05             0.05   0.472 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  6              0.05             0.05   0.578 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  7              0.05             0.05   0.683 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  8              0.05             0.05   0.789 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
##  9              0.05             0.05   0.894 &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
## 10              0.05             0.05   1     &lt;tibble [â€¦ &lt;tibble â€¦ &lt;tibble [100â€¦
## # â€¦ with 990 more rows</code></pre>
</div>
<div id="evaluate-sites" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluate-sites" class="anchor"></a>Evaluate Sites</h2>
<p>We apply <a href="https://openpharma.github.io/simaerep/reference/eval_sites.html">eval_sites()</a> to balance the bootstrapped probabilities by the expected number of false positives.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> df_eval <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span><span class="va">df_sim_sites</span>,
                                      <span class="va">eval_sites</span>,
                                      r_sim_sites <span class="op">=</span> <span class="fl">1000</span>,
                                      .progress <span class="op">=</span> <span class="cn">FALSE</span>,
                                      .options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                                      <span class="op">)</span>
  <span class="op">)</span>

<span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 7
##    ae_per_visit_meâ€¦ frac_site_with_â€¦ ur_rate df_visit df_site df_sim_sites
##               &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;   &lt;list&gt;  &lt;list&gt;      
##  1             0.05             0.05   0.05  &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  2             0.05             0.05   0.156 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  3             0.05             0.05   0.261 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  4             0.05             0.05   0.367 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  5             0.05             0.05   0.472 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  6             0.05             0.05   0.578 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  7             0.05             0.05   0.683 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  8             0.05             0.05   0.789 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  9             0.05             0.05   0.894 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
## 10             0.05             0.05   1     &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
## # â€¦ with 990 more rows, and 1 more variable: df_eval &lt;list&gt;</code></pre>
</div>
<div id="get-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#get-metrics" class="anchor"></a>Get Metrics</h2>
<p>Apart from calculating true and false positives rate for the final under-reporting probability we also calculate the same metrics for a couple of benchmark probabilities.</p>
<ul>
<li>p-values returned from <code><a href="https://rdrr.io/r/stats/poisson.test.html">poisson.test()</a></code>
</li>
<li>and the probabilities and p-values before adjusting for the expected false positives</li>
</ul>
<p>In all cases we use a 95% probability threshold.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_metrics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_visit</span>, <span class="va">df_eval</span>, <span class="va">method</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ptest"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">prob_ur_adj</span> <span class="op">=</span> <span class="st">"pval_prob_ur"</span>
    <span class="va">prob_ur_unadj</span> <span class="op">=</span> <span class="st">"pval"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">prob_ur_adj</span> <span class="op">=</span> <span class="st">"prob_low_prob_ur"</span>
    <span class="va">prob_ur_unadj</span> <span class="op">=</span> <span class="st">"prob_low"</span>
  <span class="op">}</span>
  
  <span class="va">df_ur</span> <span class="op">&lt;-</span> <span class="va">df_visit</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">site_number</span>, <span class="va">is_ur</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span>

  <span class="va">df_metric_prep</span> <span class="op">&lt;-</span> <span class="va">df_eval</span> <span class="op">%&gt;%</span>
    <span class="fu">left_join</span><span class="op">(</span><span class="va">df_ur</span>, <span class="st">"site_number"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span><span class="op">(</span> prob_ur_adj <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span><span class="op">(</span><span class="va">prob_ur_adj</span><span class="op">)</span>,
            prob_ur_unadj <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span><span class="op">(</span><span class="va">prob_ur_unadj</span><span class="op">)</span> <span class="op">)</span>
  
  <span class="va">df_metric_adjusted</span> <span class="op">&lt;-</span> <span class="va">df_metric_prep</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">is_ur</span>, <span class="va">prob_ur_adj</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span> tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span> <span class="op">&amp;</span> <span class="va">prob_ur_adj</span> <span class="op">&gt;=</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            fn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span> <span class="op">&amp;</span> <span class="va">prob_ur_adj</span> <span class="op">&lt;</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            tn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">prob_ur_adj</span> <span class="op">&lt;</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            fp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">prob_ur_adj</span> <span class="op">&gt;=</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob_ur_adj</span> <span class="op">&gt;=</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob_ur_adj</span> <span class="op">&lt;</span> <span class="fl">0.95</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">site_number</span>, <span class="op">-</span> <span class="va">is_ur</span>, <span class="op">-</span> <span class="va">prob_ur_adj</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize_all</span><span class="op">(</span><span class="va">sum</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>prob_type <span class="op">=</span> <span class="st">"adjusted"</span><span class="op">)</span>
  
  <span class="va">df_metric_unadjusted</span> <span class="op">&lt;-</span> <span class="va">df_metric_prep</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">is_ur</span>, <span class="va">prob_ur_unadj</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span> tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span> <span class="op">&amp;</span> <span class="va">prob_ur_unadj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            fn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span> <span class="op">&amp;</span> <span class="va">prob_ur_unadj</span> <span class="op">&gt;</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            tn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">prob_ur_unadj</span> <span class="op">&gt;</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            fp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">prob_ur_unadj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob_ur_unadj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob_ur_unadj</span> <span class="op">&gt;</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is_ur</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
            N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span> <span class="va">is_ur</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">site_number</span>, <span class="op">-</span> <span class="va">is_ur</span>, <span class="op">-</span> <span class="va">prob_ur_unadj</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize_all</span><span class="op">(</span><span class="va">sum</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>prob_type <span class="op">=</span> <span class="st">"unadjusted"</span><span class="op">)</span>
  
  <span class="va">df_metric</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">df_metric_adjusted</span>, <span class="va">df_metric_unadjusted</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>method <span class="op">=</span> <span class="va">method</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">df_grid</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>df_metric_pval <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_map2</a></span><span class="op">(</span><span class="va">df_visit</span>, <span class="va">df_eval</span>,
                                              <span class="va">get_metrics</span>,
                                              method <span class="op">=</span> <span class="st">"ptest"</span><span class="op">)</span>,
         df_metric_prob_low <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_map2</a></span><span class="op">(</span><span class="va">df_visit</span>, <span class="va">df_eval</span>,
                                                <span class="va">get_metrics</span>,
                                                method <span class="op">=</span> <span class="st">"bootstrap"</span><span class="op">)</span>,
         df_metric <span class="op">=</span> <span class="fu">map2</span><span class="op">(</span><span class="va">df_metric_pval</span>, <span class="va">df_metric_prob_low</span>, <span class="va">bind_rows</span><span class="op">)</span>
         <span class="op">)</span>

<span class="va">df_grid</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 10
##    ae_per_visit_meâ€¦ frac_site_with_â€¦ ur_rate df_visit df_site df_sim_sites
##               &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;   &lt;list&gt;  &lt;list&gt;      
##  1             0.05             0.05   0.05  &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  2             0.05             0.05   0.156 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  3             0.05             0.05   0.261 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  4             0.05             0.05   0.367 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  5             0.05             0.05   0.472 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  6             0.05             0.05   0.578 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  7             0.05             0.05   0.683 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  8             0.05             0.05   0.789 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
##  9             0.05             0.05   0.894 &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
## 10             0.05             0.05   1     &lt;tibbleâ€¦ &lt;tibblâ€¦ &lt;tibble [10â€¦
## # â€¦ with 990 more rows, and 4 more variables: df_eval &lt;list&gt;,
## #   df_metric_pval &lt;list&gt;, df_metric_prob_low &lt;list&gt;, df_metric &lt;list&gt;</code></pre>
</div>
</div>
<div id="plot" class="section level1">
<h1 class="hasAnchor">
<a href="#plot" class="anchor"></a>Plot</h1>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="va">df_grid</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">ae_per_visit_mean</span>, <span class="va">frac_site_with_ur</span>, <span class="va">ur_rate</span>, <span class="va">df_metric</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">df_metric</span><span class="op">)</span>

<span class="va">df_plot</span></code></pre></div>
<pre><code>## # A tibble: 4,000 x 14
##    ae_per_visit_meâ€¦ frac_site_with_â€¦ ur_rate study_id    tp    fn    tn    fp
##               &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1             0.05             0.05   0.05  S 1          0     5    95     0
##  2             0.05             0.05   0.05  S 1          0     5    94     1
##  3             0.05             0.05   0.05  S 1          0     5    95     0
##  4             0.05             0.05   0.05  S 1          0     5    93     2
##  5             0.05             0.05   0.156 S 2          0     5    95     0
##  6             0.05             0.05   0.156 S 2          1     4    93     2
##  7             0.05             0.05   0.156 S 2          0     5    95     0
##  8             0.05             0.05   0.156 S 2          1     4    91     4
##  9             0.05             0.05   0.261 S 3          0     5    95     0
## 10             0.05             0.05   0.261 S 3          0     5    94     1
## # â€¦ with 3,990 more rows, and 6 more variables: p &lt;dbl&gt;, n &lt;dbl&gt;, P &lt;dbl&gt;,
## #   N &lt;dbl&gt;, prob_type &lt;chr&gt;, method &lt;chr&gt;</code></pre>
</div>
<div id="true-positive-rate---p---tpp" class="section level1">
<h1 class="hasAnchor">
<a href="#true-positive-rate---p---tpp" class="anchor"></a>True positive rate - P - TP/P</h1>
<p>When comparing bootstrap method against the poisson.test benchmark test, we find that they perform mostly similar from a 0.05 - 0.3 ratio of under-reporting sites. Its performance is still acceptable from a 0.3 - 0.5 ratio and then becomes pretty useless.</p>
<p>As expected detection of under-reporting sites is close too impossible when the ae/visit ratio is very low (0.05) with detection rates close to zero for all tested scenarios.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">df_plot</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> tp_P_ratio <span class="op">=</span> <span class="va">tp</span><span class="op">/</span><span class="va">P</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">ae_per_visit_mean</span>, <span class="va">frac_site_with_ur</span>, <span class="va">ur_rate</span>, <span class="va">tp_P_ratio</span>, <span class="va">method</span>, <span class="va">prob_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>metric <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ptest"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"unadjusted"</span> <span class="op">~</span> <span class="st">"ptest unadjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"ptest"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"adjusted"</span> <span class="op">~</span> <span class="st">"ptest adjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"bootstrap"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"unadjusted"</span> <span class="op">~</span> <span class="st">"bootstrap unadjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"bootstrap"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"adjusted"</span> <span class="op">~</span> <span class="st">"bootstrap adjusted"</span><span class="op">)</span>,
         metric <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">metric</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ptest unadjusted"</span>, <span class="st">"ptest adjusted"</span>,
                                        <span class="st">"bootstrap unadjusted"</span>, <span class="st">"bootstrap adjusted"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">ae_per_visit_mean</span>, <span class="va">tp_P_ratio</span>, color <span class="op">=</span> <span class="va">metric</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="va">prob_type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">facet_grid</span><span class="op">(</span> <span class="va">frac_site_with_ur</span> <span class="op">~</span> <span class="va">ur_rate</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dodgerblue3"</span>, <span class="st">"skyblue1"</span>, <span class="st">"sienna4"</span>, <span class="st">"peru"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"AE Under Reporting Rate ~ Rate of AE Under-Reporting Sites"</span>,
         y <span class="op">=</span> <span class="st">"True positive rate - tp/P"</span>,
         x <span class="op">=</span> <span class="st">"AEs per Visit"</span><span class="op">)</span>
<span class="va">p</span></code></pre></div>
<p><img src="usability_limits_files/figure-html/unnamed-chunk-10-1.png" width="960"></p>
</div>
<div id="false-positive-rate-fpn" class="section level1">
<h1 class="hasAnchor">
<a href="#false-positive-rate-fpn" class="anchor"></a>False positive rate FP/N</h1>
<p>We can show that adjusting the AE under-reporting probability for the expected number of false positives is quite effective.As the false positive rate is almost zero for all tested scenarios. However, this also comes at a cost lowering the true positive rate as well.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">df_plot</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span> fpr <span class="op">=</span> <span class="va">fp</span><span class="op">/</span><span class="va">N</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">ae_per_visit_mean</span>, <span class="va">frac_site_with_ur</span>, <span class="va">ur_rate</span>, <span class="va">fpr</span>, <span class="va">method</span>, <span class="va">prob_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>metric <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"ptest"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"unadjusted"</span> <span class="op">~</span> <span class="st">"ptest unadjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"ptest"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"adjusted"</span> <span class="op">~</span> <span class="st">"ptest adjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"bootstrap"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"unadjusted"</span> <span class="op">~</span> <span class="st">"bootstrap unadjusted"</span>,
                           <span class="va">method</span> <span class="op">==</span> <span class="st">"bootstrap"</span> <span class="op">&amp;</span> <span class="va">prob_type</span> <span class="op">==</span> <span class="st">"adjusted"</span> <span class="op">~</span> <span class="st">"bootstrap adjusted"</span><span class="op">)</span>,
         metric <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">metric</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ptest unadjusted"</span>, <span class="st">"ptest adjusted"</span>,
                                        <span class="st">"bootstrap unadjusted"</span>, <span class="st">"bootstrap adjusted"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">ae_per_visit_mean</span>, <span class="va">fpr</span>, color <span class="op">=</span> <span class="va">metric</span>, linetype <span class="op">=</span> <span class="va">prob_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">facet_grid</span><span class="op">(</span> <span class="va">frac_site_with_ur</span> <span class="op">~</span> <span class="va">ur_rate</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dodgerblue3"</span>, <span class="st">"skyblue1"</span>, <span class="st">"sienna4"</span>, <span class="st">"peru"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"AE Under Reporting Rate by Rate of AE Under-Reporting Sites"</span>,
         y <span class="op">=</span> <span class="st">"False positive rate - fp/N"</span>,
         x <span class="op">=</span> <span class="st">"AEs per Visit"</span><span class="op">)</span>
<span class="va">p</span></code></pre></div>
<p><img src="usability_limits_files/figure-html/unnamed-chunk-11-1.png" width="960"></p>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>As already outlined in the <a href="https://openpharma.github.io/simaerep/articles/intro.html#advantage-over-classic-statistical-tests">introduction</a> the true AE generating process is unlikely to be a standard poisson process. Therefore using a non-parametric test remains our recommended option unless that there is a reason to believe that 50% or more of all sites are under-reporting AEs. We also show that it is important to adjust for the expected false positive rate when calculating the final probabilities.</p>
<p>In general we can say that we do not recommend any method for detecting AE under-reporting that involves comparing AE counts if the ae per visit rate is 0.05 or lower.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
