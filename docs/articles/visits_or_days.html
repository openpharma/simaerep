<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aggregate AEs by Days or Visit? â€¢ simaerep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Aggregate AEs by Days or Visit?">
<meta property="og:description" content="simaerep">
<meta property="og:image" content="https://openpharma.github.io/simaerep/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simaerep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/intro.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/usability_limits.html">Address Usability Limits of Bootstrap Method</a>
    </li>
    <li>
      <a href="../articles/check_poisson.html">Check Poisson Test Applicability</a>
    </li>
    <li>
      <a href="../articles/sas_files.html">SAS Files as a Data Source</a>
    </li>
    <li>
      <a href="../articles/visit_med75.html">Adjusted Evaluation Point visit_med75</a>
    </li>
    <li>
      <a href="../articles/visits_or_days.html">Aggregate AEs by Days or Visit?</a>
    </li>
    <li>
      <a href="../articles/portfolio_perf.html">simaerep Portfolio Performance</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/openpharma/simaerep/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="visits_or_days_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Aggregate AEs by Days or Visit?</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/simaerep/blob/master/vignettes/visits_or_days.Rmd"><code>vignettes/visits_or_days.Rmd</code></a></small>
      <div class="hidden name"><code>visits_or_days.Rmd</code></div>

    </div>

    
    
<div id="load" class="section level1">
<h1 class="hasAnchor">
<a href="#load" class="anchor"></a>Load</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/simaerep/">simaerep</a></span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>We generally aggregate AEs by visit. Each patient follows the same visit schedule and a specified number of days passes between each consecutive visit. As visits are a scheduled contact point between the patient and physicians the day of the visit usually also the day when most AEs get reported. Alternatively we can also choose to use <code>simaerep</code> to a</p>
</div>
<div id="load-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load Data</h1>
<p>We load some a public clinical trial data set which only contains data of the control arm <a href="https://openpharma.github.io/simaerep/articles/sas_files.html">see SAS files as a Data Source Article</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_ae</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_sas.html">read_sas</a></span><span class="op">(</span><span class="st">'adae.sas7bdat'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SUBJID</span>, <span class="va">SITEID</span>, <span class="va">AESTDY</span><span class="op">)</span> 

<span class="va">df_vs</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_sas.html">read_sas</a></span><span class="op">(</span><span class="st">'advs.sas7bdat'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SUBJID</span>, <span class="va">SITEID</span>, <span class="va">ADY</span><span class="op">)</span> 

<span class="va">df_ae</span> <span class="op">&lt;-</span> <span class="va">df_ae</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>DY <span class="op">=</span> <span class="va">AESTDY</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>EVENT <span class="op">=</span> <span class="st">"AE"</span><span class="op">)</span>

<span class="va">df_vs</span> <span class="op">&lt;-</span> <span class="va">df_vs</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>DY <span class="op">=</span> <span class="va">ADY</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>EVENT <span class="op">=</span> <span class="st">"VS"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># we ignore visits that have no date</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">DY</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># we are not interested in same day visits</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span>

<span class="va">df_aevs</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">df_ae</span>, <span class="va">df_vs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># NA's get sorted towards the end thus AEs with no date get sorted towards last visit</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span>, <span class="va">DY</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>AE_NO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">EVENT</span> <span class="op">==</span> <span class="st">"AE"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,
         VS_NO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">EVENT</span> <span class="op">==</span> <span class="st">"VS"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># we remove patients with 0 visits</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">VS_NO</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># AE's before fist visit should register to visit 1 not zero</span>
  <span class="fu">mutate</span><span class="op">(</span>VS_NO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">VS_NO</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">VS_NO</span><span class="op">)</span><span class="op">)</span>


<span class="va">df_aevs_aggr</span> <span class="op">&lt;-</span> <span class="va">df_aevs</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span>, <span class="va">VS_NO</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>MIN_AE_NO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">AE_NO</span><span class="op">)</span>,
            MAX_AE_NO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">AE_NO</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>MAX_VS_PAT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">VS_NO</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># assign AEs that occur after last visit to last AE</span>
  <span class="fu">mutate</span><span class="op">(</span>
    CUM_AE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
      <span class="va">VS_NO</span> <span class="op">==</span> <span class="va">MAX_VS_PAT</span>,
      <span class="va">MAX_AE_NO</span>,
      <span class="va">MIN_AE_NO</span><span class="op">)</span>
    <span class="op">)</span>

<span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="va">df_aevs_aggr</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>
    study_id <span class="op">=</span> <span class="st">"STUDYID"</span>,
    site_number <span class="op">=</span> <span class="st">"SITEID"</span>,
    patnum <span class="op">=</span> <span class="st">"SUBJID"</span>,
    n_ae <span class="op">=</span> <span class="st">"CUM_AE"</span>,
    visit <span class="op">=</span> <span class="st">"VS_NO"</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span>, <span class="va">n_ae</span>, <span class="va">visit</span><span class="op">)</span></code></pre></div>
</div>
<div id="aggregate-on-days" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregate-on-days" class="anchor"></a>Aggregate on Days</h1>
<p>For aggregating on days we need to align the reference timelines of the single patients.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_vs_min_max</span> <span class="op">&lt;-</span> <span class="va">df_vs</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SUBJID</span>, <span class="va">SITEID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>min_DY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">DY</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            max_DY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">DY</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

<span class="va">df_vs_min_max</span><span class="op">$</span><span class="va">min_DY</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1]  -7 -14 -14  -7  -3 -10 -19 -12  -6  -9  -9 -12  -8  -7  -6  -8  -3 -14  -7
## [20] -14 -19 -12  -9 -21 -28</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_vs_min_max</span><span class="op">$</span><span class="va">max_DY</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1] 309 134  43   1 224 265 100 163  51 103  40  38 125 168  85  92 100 708 119
## [20]  64  43  51  70   1 225</code></pre>
<p>The day of the first visit is different for each patient and they start at negative values. First we correct all values to be positive and then normalize the AE date values to the date value of the first visit of each patient</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">corr_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">df_vs_min_max</span><span class="op">$</span><span class="va">min_DY</span><span class="op">)</span><span class="op">)</span>

<span class="va">df_days</span> <span class="op">&lt;-</span> <span class="va">df_ae</span> <span class="op">%&gt;%</span>
  <span class="co"># include patients with vs but no AE</span>
  <span class="fu">right_join</span><span class="op">(</span><span class="va">df_vs_min_max</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"STUDYID"</span>, <span class="st">"SUBJID"</span>, <span class="st">"SITEID"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># replace DY NULL with max patient DY </span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SUBJID</span>, <span class="va">SITEID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>DY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">DY</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">EVENT</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">DY</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="va">DY</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># replace DY for patients with 0 AE with day of maximum visit</span>
  <span class="fu">mutate</span><span class="op">(</span>DY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">DY</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">EVENT</span><span class="op">)</span>, <span class="va">max_DY</span>, <span class="va">DY</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># correct timelines</span>
  <span class="fu">mutate</span><span class="op">(</span>DY <span class="op">=</span> <span class="va">DY</span> <span class="op">+</span> <span class="va">corr_factor</span>,
         min_DY <span class="op">=</span> <span class="va">min_DY</span> <span class="op">+</span> <span class="va">corr_factor</span>,
         DY_corr <span class="op">=</span> <span class="va">DY</span> <span class="op">+</span> <span class="va">min_DY</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">SITEID</span>, <span class="va">SUBJID</span>, <span class="va">DY_corr</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>n_ae <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># set AE count to 0 for patients with no AEs</span>
  <span class="fu">mutate</span><span class="op">(</span>n_ae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">EVENT</span><span class="op">)</span>, <span class="fl">0</span> , <span class="va">n_ae</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>
    study_id <span class="op">=</span> <span class="va">STUDYID</span>,
    site_number <span class="op">=</span> <span class="va">SITEID</span>,
    patnum <span class="op">=</span> <span class="va">SUBJID</span>,
    visit <span class="op">=</span> <span class="va">DY_corr</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span>, <span class="va">visit</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>n_ae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_ae</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<p>check if we get the same transformation as for the visit aggregations</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">df_days</span><span class="op">$</span><span class="va">site_number</span><span class="op">)</span> <span class="op">==</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">df_visit</span><span class="op">$</span><span class="va">site_number</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu">n_distinct</span><span class="op">(</span><span class="va">df_days</span><span class="op">$</span><span class="va">patnum</span><span class="op">)</span> <span class="op">==</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">df_visit</span><span class="op">$</span><span class="va">patnum</span><span class="op">)</span><span class="op">)</span>

<span class="va">pat0_days</span> <span class="op">&lt;-</span> <span class="va">df_days</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_ae</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pull</span><span class="op">(</span><span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">pat0_vs</span> <span class="op">&lt;-</span> <span class="va">df_visit</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_ae</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pull</span><span class="op">(</span><span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">pat0_days</span> <span class="op">==</span> <span class="va">pat0_vs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_days</span> </code></pre></div>
<pre><code>## # A tibble: 3,220 x 5
##    study_id   site_number patnum   visit  n_ae
##  * &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1 CO-101-001 001         01001001    43     1
##  2 CO-101-001 001         01001001    44     2
##  3 CO-101-001 001         01001001   107     3
##  4 CO-101-001 001         01001001   124     4
##  5 CO-101-001 001         01001001   134     5
##  6 CO-101-001 001         01001001   141     6
##  7 CO-101-001 001         01001001   156     8
##  8 CO-101-001 001         01001001   184    10
##  9 CO-101-001 001         01001001   240    13
## 10 CO-101-001 001         01001001   241    14
## # â€¦ with 3,210 more rows</code></pre>
<p>We do have gaps in between the days leading to implicitly missing values. <code>simaerep</code> will correct this automatically and throw a warning.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/site_aggr.html">site_aggr</a></span><span class="op">(</span>df_visit <span class="op">=</span> <span class="va">df_days</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in exp_implicit_missing_visits(df_visit): implicitly missing visit
## numbers detected and corrected</code></pre>
<p>to silence the warning we can use <code>check df_visit()</code> which is also called internally by all other functions accepting <code>df_visit</code> as an argument.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_days</span> <span class="op">&lt;-</span> <span class="fu">simaerep</span><span class="fu">:::</span><span class="fu"><a href="../reference/check_df_visit.html">check_df_visit</a></span><span class="op">(</span><span class="va">df_days</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in exp_implicit_missing_visits(df_visit): implicitly missing visit
## numbers detected and corrected</code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_days</span></code></pre></div>
<pre><code>## # A tibble: 57,873 x 5
##    study_id   site_number patnum   visit  n_ae
##  * &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1 CO-101-001 001         01001001     5     0
##  2 CO-101-001 001         01001001     6     0
##  3 CO-101-001 001         01001001     7     0
##  4 CO-101-001 001         01001001     8     0
##  5 CO-101-001 001         01001001     9     0
##  6 CO-101-001 001         01001001    10     0
##  7 CO-101-001 001         01001001    11     0
##  8 CO-101-001 001         01001001    12     0
##  9 CO-101-001 001         01001001    13     0
## 10 CO-101-001 001         01001001    14     0
## # â€¦ with 57,863 more rows</code></pre>
<p>Then we proceed as usual.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_sim_sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_sites.html">sim_sites</a></span><span class="op">(</span><span class="va">df_site</span>, df_visit <span class="op">=</span> <span class="va">df_days</span><span class="op">)</span>

<span class="va">df_eval_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_sites.html">eval_sites</a></span><span class="op">(</span><span class="va">df_sim_sites</span><span class="op">)</span>

<span class="fu">simaerep</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_study.html">plot_study</a></span><span class="op">(</span>df_visit <span class="op">=</span> <span class="va">df_days</span>, df_site <span class="op">=</span> <span class="va">df_site</span>, df_eval <span class="op">=</span> <span class="va">df_eval_days</span>, study <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df_days</span><span class="op">$</span><span class="va">study_id</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="visits_or_days_files/figure-html/unnamed-chunk-9-1.png" width="960"></p>
</div>
<div id="aggregate-on-visits" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregate-on-visits" class="anchor"></a>Aggregate on Visits</h1>
<p>How do the results compare to aggregating on visits?</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/site_aggr.html">site_aggr</a></span><span class="op">(</span><span class="va">df_visit</span><span class="op">)</span> 

<span class="va">df_sim_sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_sites.html">sim_sites</a></span><span class="op">(</span><span class="va">df_site</span>, <span class="va">df_visit</span><span class="op">)</span>

<span class="va">df_eval_vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_sites.html">eval_sites</a></span><span class="op">(</span><span class="va">df_sim_sites</span><span class="op">)</span>

<span class="fu">simaerep</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_study.html">plot_study</a></span><span class="op">(</span><span class="va">df_visit</span>, <span class="va">df_site</span>, <span class="va">df_eval_vs</span>, study <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df_visit</span><span class="op">$</span><span class="va">study_id</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="visits_or_days_files/figure-html/unnamed-chunk-10-1.png" width="960"></p>
</div>
<div id="compare" class="section level1">
<h1 class="hasAnchor">
<a href="#compare" class="anchor"></a>Compare</h1>
<p>We observe a difference in the results. Which is largely attributable in the difference in cut-off visit_med75 points that influences the set of patients included. In any case we observe a high rank correlation with a low p-value of all results greater 0.</p>
<p>As the inclusion/exclusion of patients in the analysis of a site in an ongoing trial can shift results, we recommend to aggregate on actually occurred visits because then all included patients had an equal amount of opportunities to report AEs.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_comp</span> <span class="op">&lt;-</span> <span class="va">df_eval_days</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>
    <span class="va">site_number</span>,
    prob_low_prob_ur_days <span class="op">=</span> <span class="va">prob_low_prob_ur</span>,
    n_pat_with_med75_days <span class="op">=</span> <span class="va">n_pat_with_med75</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="fu">select</span><span class="op">(</span>
      <span class="va">df_eval_vs</span>,
      <span class="va">site_number</span>,
      prob_low_prob_ur_vs <span class="op">=</span> <span class="va">prob_low_prob_ur</span>,
      n_pat_with_med75_vs <span class="op">=</span> <span class="va">n_pat_with_med75</span>
      <span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"site_number"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prob_low_prob_ur_days</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">prob_low_prob_ur_vs</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">site_number</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"prob"</span><span class="op">)</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"n_pat"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">prob_low_prob_ur_vs</span><span class="op">)</span><span class="op">)</span>

<span class="va">df_comp</span> <span class="op">%&gt;%</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="12%">
<col width="22%">
<col width="20%">
<col width="22%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th align="left">site_number</th>
<th align="right">prob_low_prob_ur_days</th>
<th align="right">prob_low_prob_ur_vs</th>
<th align="right">n_pat_with_med75_days</th>
<th align="right">n_pat_with_med75_vs</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">084</td>
<td align="right">0.975000</td>
<td align="right">0.9625000</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">078</td>
<td align="right">0.975000</td>
<td align="right">0.9625000</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">073</td>
<td align="right">0.409375</td>
<td align="right">0.8000000</td>
<td align="right">6</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">067</td>
<td align="right">1.000000</td>
<td align="right">0.7375000</td>
<td align="right">17</td>
<td align="right">15</td>
</tr>
<tr class="odd">
<td align="left">079</td>
<td align="right">0.831250</td>
<td align="right">0.6875000</td>
<td align="right">13</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">086</td>
<td align="right">0.450000</td>
<td align="right">0.6875000</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">066</td>
<td align="right">0.550000</td>
<td align="right">0.1923077</td>
<td align="right">6</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">070</td>
<td align="right">0.409375</td>
<td align="right">0.1923077</td>
<td align="right">15</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="left">080</td>
<td align="right">0.047500</td>
<td align="right">0.1923077</td>
<td align="right">20</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="left">085</td>
<td align="right">0.047500</td>
<td align="right">0.1923077</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">069</td>
<td align="right">0.000000</td>
<td align="right">0.1923077</td>
<td align="right">3</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">090</td>
<td align="right">0.000000</td>
<td align="right">0.1923077</td>
<td align="right">3</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">071</td>
<td align="right">0.000000</td>
<td align="right">0.1923077</td>
<td align="right">2</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span>
  <span class="va">df_comp</span><span class="op">$</span><span class="va">prob_low_prob_ur_vs</span>,
  <span class="va">df_comp</span><span class="op">$</span><span class="va">prob_low_prob_ur_days</span>,
  method <span class="op">=</span> <span class="st">"spearman"</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Warning in cor.test.default(df_comp$prob_low_prob_ur_vs,
## df_comp$prob_low_prob_ur_days, : Cannot compute exact p-value with ties</code></pre>
<pre><code>## 
##  Spearman's rank correlation rho
## 
## data:  df_comp$prob_low_prob_ur_vs and df_comp$prob_low_prob_ur_days
## S = 84.269, p-value = 0.002146
## alternative hypothesis: true rho is not equal to 0
## sample estimates:
##       rho 
## 0.7684912</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
