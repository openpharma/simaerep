<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>simaerep Portfolio Performance • simaerep</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="simaerep Portfolio Performance">
<meta property="og:description" content="simaerep">
<meta property="og:image" content="https://openpharma.github.io/simaerep/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simaerep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/intro.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/usability_limits.html">Address Usability Limits of Bootstrap Method</a>
    </li>
    <li>
      <a href="../articles/check_poisson.html">Check Poisson Test Applicability</a>
    </li>
    <li>
      <a href="../articles/sas_files.html">SAS Files as a Data Source</a>
    </li>
    <li>
      <a href="../articles/visit_med75.html">Adjusted Evaluation Point visit_med75</a>
    </li>
    <li>
      <a href="../articles/visits_or_days.html">Aggregate AEs by Days or Visit?</a>
    </li>
    <li>
      <a href="../articles/portfolio_perf.html">simaerep Portfolio Performance</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/openpharma/simaerep/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="portfolio_perf_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>simaerep Portfolio Performance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/simaerep/blob/master/vignettes/portfolio_perf.Rmd"><code>vignettes/portfolio_perf.Rmd</code></a></small>
      <div class="hidden name"><code>portfolio_perf.Rmd</code></div>

    </div>

    
    
<div id="load" class="section level1">
<h1 class="hasAnchor">
<a href="#load" class="anchor"></a>Load</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/simaerep/">simaerep</a></span><span class="op">)</span><span class="op">)</span>

<span class="co"># RAM ~26 GB</span>
<span class="co"># plan 2GB per core</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></code></pre></div>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>We want to define minimal requirements for simulating test data that reflects realistic portfolio data which we then want to use to benchmark overall {simaerep} performance.</p>
</div>
<div id="performance" class="section level1">
<h1 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h1>
<p>These simulations take some time to run and require multiple cores and appropriate memory. Rendering articles in {pkgdown} can be a bit unstable so we recommend to render first using pure {rmarkdown} to generate the intermediate csv files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmarkdown/man/render.html">render</a></span><span class="op">(</span><span class="st">"vignettes/_portfolio_perf.Rmd"</span>, knit_root_dir <span class="op">=</span> <span class="st">"/home/koneswab/simaerep"</span><span class="op">)</span></code></pre></div>
</div>
<div id="portfolio-configuration" class="section level1">
<h1 class="hasAnchor">
<a href="#portfolio-configuration" class="anchor"></a>Portfolio Configuration</h1>
<p>The portfolio configuration should give a minimal description of a portfolio without violating data privacy laws or competitive intellectual property. We propose to include the following metrics into the portfolio configuration:</p>
<p><strong>site parameters:</strong></p>
<ul>
<li>mean of all maximum patient visits</li>
<li>sd of of all maximum patient visits</li>
<li>total number patients</li>
</ul>
<p><strong>study parameters:</strong></p>
<ul>
<li>mean AE per visit</li>
</ul>
<p>The information contained in a portfolio configuration is very scarce and thus can be shared more easily within the industry. We can use those parameters to simulate test data for assessing {simaerep} performance on a given portfolio.</p>
<p>We can start with a maximum aggregation of visit and n_ae on patient level starting with df_visit as we would use it for <code><a href="../reference/site_aggr.html">simaerep::site_aggr()</a></code>. We can use <code><a href="../reference/get_config.html">simaerep::get_config</a></code> to generate a valid portfolio configuration, which will automatically apply a few filters:</p>
<ul>
<li>remove patients with 0 visits</li>
<li>minimum number of patients per study</li>
<li>minimum number of sites per study</li>
<li>anonymize study and site IDs</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_visit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span>n_pat <span class="op">=</span> <span class="fl">100</span>, n_sites <span class="op">=</span> <span class="fl">10</span>,
   frac_site_with_ur <span class="op">=</span> <span class="fl">0.4</span>, ur_rate <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>

<span class="va">df_visit1</span><span class="op">$</span><span class="va">study_id</span> <span class="op">&lt;-</span> <span class="st">"A"</span>

<span class="va">df_visit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_study.html">sim_test_data_study</a></span><span class="op">(</span>n_pat <span class="op">=</span> <span class="fl">100</span>, n_sites <span class="op">=</span> <span class="fl">10</span>,
                                      frac_site_with_ur <span class="op">=</span> <span class="fl">0.2</span>, ur_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>

<span class="va">df_visit2</span><span class="op">$</span><span class="va">study_id</span> <span class="op">&lt;-</span> <span class="st">"B"</span>

<span class="va">df_visit</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">df_visit1</span>, <span class="va">df_visit2</span><span class="op">)</span>

<span class="va">df_site_max</span> <span class="op">&lt;-</span> <span class="va">df_visit</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>max_visit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">visit</span><span class="op">)</span>,
            max_ae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_ae</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

<span class="va">df_config</span> <span class="op">&lt;-</span> <span class="fu">simaerep</span><span class="fu">::</span><span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span>
  <span class="va">df_site_max</span>, anonymize <span class="op">=</span> <span class="cn">TRUE</span>,
  min_pat_per_study <span class="op">=</span> <span class="fl">100</span>,
  min_sites_per_study <span class="op">=</span> <span class="fl">10</span>
<span class="op">)</span>

<span class="va">df_config</span></code></pre></div>
<pre><code>## # A tibble: 20 x 6
##    study_id ae_per_visit_mean site_number max_visit_sd max_visit_mean n_pat
##    &lt;chr&gt;                &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;int&gt;
##  1 0001                 0.382 0001                4.34           21.2    10
##  2 0001                 0.382 0002                3.94           21.2    10
##  3 0001                 0.382 0003                5.23           17.5    10
##  4 0001                 0.382 0004                3.37           18.5    10
##  5 0001                 0.382 0005                4.08           18.3    10
##  6 0001                 0.382 0006                4.76           18.3    10
##  7 0001                 0.382 0007                4.03           18.4    10
##  8 0001                 0.382 0008                4.24           21.2    10
##  9 0001                 0.382 0009                3.02           19      10
## 10 0001                 0.382 0010                2.49           20.2    10
## 11 0002                 0.505 0001                3.77           19.2    10
## 12 0002                 0.505 0002                4.37           18.3    10
## 13 0002                 0.505 0003                2.22           19.6    10
## 14 0002                 0.505 0004                4.79           18.7    10
## 15 0002                 0.505 0005                2.79           17.7    10
## 16 0002                 0.505 0006                3.86           22.3    10
## 17 0002                 0.505 0007                4.42           18.7    10
## 18 0002                 0.505 0008                5.03           21.2    10
## 19 0002                 0.505 0009                4.24           19.8    10
## 20 0002                 0.505 0010                4.01           22.1    10</code></pre>
<div id="simulate-portfolio-from-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-portfolio-from-configuration" class="anchor"></a>Simulate Portfolio from Configuration</h2>
<p>We can now apply sim_test_data_portfolio which uses <code><a href="../reference/sim_test_data_study.html">sim_test_data_study()</a></code> to generate artificial data on visit level.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_portf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_portfolio.html">sim_test_data_portfolio</a></span><span class="op">(</span><span class="va">df_config</span><span class="op">)</span>
<span class="va">df_portf</span></code></pre></div>
<pre><code>## # A tibble: 3,804 x 8
##    study_id ae_per_visit_me… site_number max_visit_sd max_visit_mean patnum
##    &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt; 
##  1 0001                0.382 0001                4.34           21.2 0001  
##  2 0001                0.382 0001                4.34           21.2 0001  
##  3 0001                0.382 0001                4.34           21.2 0001  
##  4 0001                0.382 0001                4.34           21.2 0001  
##  5 0001                0.382 0001                4.34           21.2 0001  
##  6 0001                0.382 0001                4.34           21.2 0001  
##  7 0001                0.382 0001                4.34           21.2 0001  
##  8 0001                0.382 0001                4.34           21.2 0001  
##  9 0001                0.382 0001                4.34           21.2 0001  
## 10 0001                0.382 0001                4.34           21.2 0001  
## # … with 3,794 more rows, and 2 more variables: visit &lt;int&gt;, n_ae &lt;int&gt;</code></pre>
</div>
<div id="load-realistic-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#load-realistic-configuration" class="anchor"></a>Load Realistic Configuration</h2>
<p>Here we load a realistic portfolio configuration.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_config</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"ae_profile.csv"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   study_id = col_character(),
##   ae_per_visit_mean = col_double(),
##   ae_per_day_mean = col_double(),
##   site_number = col_character(),
##   max_visit_sd = col_double(),
##   max_visit_mean = col_double(),
##   max_days_sd = col_double(),
##   max_days_mean = col_double(),
##   n_pat = col_double()
## )</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_config</span></code></pre></div>
<pre><code>## # A tibble: 15,674 x 9
##    study_id ae_per_visit_me… ae_per_day_mean site_number max_visit_sd
##    &lt;chr&gt;               &lt;dbl&gt;           &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;
##  1 0001                0.269         0.00725 0001               0.707
##  2 0001                0.269         0.00725 0002               2.12 
##  3 0001                0.269         0.00725 0003               0.577
##  4 0001                0.269         0.00725 0004               8.87 
##  5 0001                0.269         0.00725 0005               0    
##  6 0001                0.269         0.00725 0006               0    
##  7 0001                0.269         0.00725 0007               0    
##  8 0001                0.269         0.00725 0008               5.34 
##  9 0001                0.269         0.00725 0009               0    
## 10 0001                0.269         0.00725 0010               1.82 
## # … with 15,664 more rows, and 4 more variables: max_visit_mean &lt;dbl&gt;,
## #   max_days_sd &lt;dbl&gt;, max_days_mean &lt;dbl&gt;, n_pat &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="simulate-portfolio" class="section level1">
<h1 class="hasAnchor">
<a href="#simulate-portfolio" class="anchor"></a>Simulate Portfolio</h1>
<p>And again simulate artificial visit level data. Using parallel processing.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_portf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_portfolio.html">sim_test_data_portfolio</a></span><span class="op">(</span><span class="va">df_config</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df_portf</span></code></pre></div>
<pre><code>## # A tibble: 1,996,906 x 11
##    study_id ae_per_visit_me… ae_per_day_mean site_number max_visit_sd
##    &lt;chr&gt;               &lt;dbl&gt;           &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;
##  1 0001                0.269         0.00725 0001               0.707
##  2 0001                0.269         0.00725 0001               0.707
##  3 0001                0.269         0.00725 0001               0.707
##  4 0001                0.269         0.00725 0001               0.707
##  5 0001                0.269         0.00725 0001               0.707
##  6 0001                0.269         0.00725 0001               0.707
##  7 0001                0.269         0.00725 0001               0.707
##  8 0001                0.269         0.00725 0001               0.707
##  9 0001                0.269         0.00725 0001               0.707
## 10 0001                0.269         0.00725 0001               0.707
## # … with 1,996,896 more rows, and 6 more variables: max_visit_mean &lt;dbl&gt;,
## #   max_days_sd &lt;dbl&gt;, max_days_mean &lt;dbl&gt;, patnum &lt;chr&gt;, visit &lt;int&gt;,
## #   n_ae &lt;int&gt;</code></pre>
<div id="confirm-that-portfolio-simulation-results-in-similar-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#confirm-that-portfolio-simulation-results-in-similar-configuration" class="anchor"></a>Confirm that Portfolio Simulation results in Similar Configuration</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_site_max_portf</span> <span class="op">&lt;-</span> <span class="va">df_portf</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">study_id</span>, <span class="va">site_number</span>, <span class="va">patnum</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>max_visit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">visit</span><span class="op">)</span>,
            max_ae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n_ae</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

<span class="va">df_config_portf</span> <span class="op">&lt;-</span> <span class="fu">simaerep</span><span class="fu">::</span><span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">df_site_max_portf</span>, anonymize <span class="op">=</span> <span class="cn">TRUE</span>, min_pat_per_study <span class="op">=</span> <span class="fl">100</span>, min_sites_per_study <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">df_comp</span> <span class="op">&lt;-</span> <span class="va">df_config</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">df_config_portf</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"study_id"</span>, <span class="st">"site_number"</span><span class="op">)</span>,
    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".ori"</span>, <span class="st">".sim"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>
    <span class="va">study_id</span>,
    <span class="fu">starts_with</span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span>,
    <span class="va">site_number</span>,
    <span class="fu">contains</span><span class="op">(</span><span class="st">"max_visit_sd"</span><span class="op">)</span>,
    <span class="fu">contains</span><span class="op">(</span><span class="st">"max_visit_mean"</span><span class="op">)</span>,
    <span class="fu">contains</span><span class="op">(</span><span class="st">"n_pat"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">df_comp</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">study_id</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">ae_per_visit_mean.ori</span>, <span class="va">ae_per_visit_mean.sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"simulated vs original AE per visit study mean"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'loess' and formula 'y ~ x'</code></pre>
<p><img src="portfolio_perf_files/figure-html/check_portf-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_comp</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">max_visit_sd.ori</span>, <span class="va">max_visit_sd.sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"simulated vs original max visit sd site"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</code></pre>
<p><img src="portfolio_perf_files/figure-html/check_portf-2.png" width="700"></p>
<p>In our portfolio simulation we sample the patient maximum visit values from a normal distribution. If that returns values smaller than 1 we replace it with one. The larger the SD values compared to the mean values the more likely we will sample a patient maximum visit smaller than one. Every time we have to do that correction we are lowering the patient maximum visit SD in our simulation, which we can see in the graph above.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_comp</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">max_visit_mean.ori</span>, <span class="va">max_visit_mean.sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"simulated vs original max visit mean site"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</code></pre>
<p><img src="portfolio_perf_files/figure-html/check_portf_2-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_comp</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">n_pat.ori</span>, <span class="va">n_pat.sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_smooth</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"simulated vs original n_pat site"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</code></pre>
<p><img src="portfolio_perf_files/figure-html/check_portf_2-2.png" width="700"></p>
</div>
</div>
<div id="get-under-reporting-probability-for-different-under-reporting-scenarios" class="section level1">
<h1 class="hasAnchor">
<a href="#get-under-reporting-probability-for-different-under-reporting-scenarios" class="anchor"></a>Get Under-Reporting Probability for Different Under Reporting Scenarios</h1>
<p>The performance of detecting AE under-reporting is dependent on three things:</p>
<ul>
<li>the higher the mean AE per visit on study level the better</li>
<li>the higher the number of patients at an under-reporting site the better</li>
<li>the higher the number of under-reporting sites in a study the worse</li>
</ul>
<p>In our initial usability assessment we have fixed those parameters. Here we are going leave them as they are in the portfolio. The vanilla version of our artificial portfolio data does not contain any under-reporting sites yet. However <code><a href="../reference/sim_ur_scenarios.html">simaerep::sim_ur_scenarios()</a></code> will apply under-reporting scenarios to each site. Reducing the number of AEs by a given under-reporting rate (ur_rate) for all patients at the site and add the corresponding under-reporting statistics. Since the under-reporting probability is also affected by the number of other sites that are under-reporting we additionally calculate under-reporting statistics in a scenario where additional under reporting sites are present. For this we use the mean number of patients per site at the study to calculate the final number of patients for which we lower the AEs in a given under-reporting scenario.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_scen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ur_scenarios.html">sim_ur_scenarios</a></span><span class="op">(</span><span class="va">df_portf</span>,
                         extra_ur_sites <span class="op">=</span> <span class="fl">5</span>,
                         ur_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>,
                         parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                         poisson <span class="op">=</span> <span class="cn">TRUE</span>,
                         prob_lower <span class="op">=</span> <span class="cn">TRUE</span>,
                         progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">df_scen</span>

<span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">df_scen</span>, file <span class="op">=</span> <span class="st">"scen.csv"</span><span class="op">)</span></code></pre></div>
</div>
<div id="portfolio-performance" class="section level1">
<h1 class="hasAnchor">
<a href="#portfolio-performance" class="anchor"></a>Portfolio Performance</h1>
<p>We can calculate the portfolio performance as the overall true positive rate (tpr as tp/P) on the basis of desired false positive rates (fpr as fp/N). We calculate a threshold based on the desired fpr using the vanilla scenario with no under-reporting sites. Then we check how many sites with known under-reporting get flagged to calculate tpr.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_scen</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"scen.csv"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   study_id = col_character(),
##   site_number = col_character(),
##   n_pat = col_double(),
##   n_pat_with_med75 = col_double(),
##   visit_med75 = col_double(),
##   mean_ae_site_med75 = col_double(),
##   mean_ae_study_med75 = col_double(),
##   n_pat_with_med75_study = col_double(),
##   extra_ur_sites = col_double(),
##   frac_pat_with_ur = col_double(),
##   ur_rate = col_double(),
##   prob_low = col_double(),
##   prob_low_adj = col_double(),
##   prob_low_prob_ur = col_double()
## )</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_perf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_portf_perf.html">get_portf_perf</a></span><span class="op">(</span><span class="va">df_scen</span><span class="op">)</span>

<span class="va">df_perf</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">extra_ur_sites</span>,
    values_from <span class="op">=</span> <span class="va">tpr</span>,
    names_prefix <span class="op">=</span> <span class="st">"extra_ur_sites_"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="4%">
<col width="5%">
<col width="6%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="right">fpr</th>
<th align="right">thresh</th>
<th align="right">ur_rate</th>
<th align="right">extra_ur_sites_0</th>
<th align="right">extra_ur_sites_1</th>
<th align="right">extra_ur_sites_2</th>
<th align="right">extra_ur_sites_3</th>
<th align="right">extra_ur_sites_4</th>
<th align="right">extra_ur_sites_5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.00</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.10</td>
<td align="right">0.007</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.25</td>
<td align="right">0.070</td>
<td align="right">0.066</td>
<td align="right">0.062</td>
<td align="right">0.058</td>
<td align="right">0.055</td>
<td align="right">0.053</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.50</td>
<td align="right">0.298</td>
<td align="right">0.279</td>
<td align="right">0.263</td>
<td align="right">0.249</td>
<td align="right">0.237</td>
<td align="right">0.227</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.75</td>
<td align="right">0.505</td>
<td align="right">0.467</td>
<td align="right">0.439</td>
<td align="right">0.424</td>
<td align="right">0.407</td>
<td align="right">0.385</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">1.00</td>
<td align="right">0.611</td>
<td align="right">0.531</td>
<td align="right">0.493</td>
<td align="right">0.479</td>
<td align="right">0.460</td>
<td align="right">0.432</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.00</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.10</td>
<td align="right">0.056</td>
<td align="right">0.054</td>
<td align="right">0.053</td>
<td align="right">0.052</td>
<td align="right">0.051</td>
<td align="right">0.049</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.25</td>
<td align="right">0.207</td>
<td align="right">0.200</td>
<td align="right">0.194</td>
<td align="right">0.187</td>
<td align="right">0.181</td>
<td align="right">0.175</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.50</td>
<td align="right">0.483</td>
<td align="right">0.467</td>
<td align="right">0.453</td>
<td align="right">0.439</td>
<td align="right">0.427</td>
<td align="right">0.416</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.75</td>
<td align="right">0.680</td>
<td align="right">0.656</td>
<td align="right">0.633</td>
<td align="right">0.610</td>
<td align="right">0.590</td>
<td align="right">0.574</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">1.00</td>
<td align="right">0.762</td>
<td align="right">0.705</td>
<td align="right">0.660</td>
<td align="right">0.620</td>
<td align="right">0.591</td>
<td align="right">0.574</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">0.00</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">0.10</td>
<td align="right">0.161</td>
<td align="right">0.159</td>
<td align="right">0.157</td>
<td align="right">0.154</td>
<td align="right">0.152</td>
<td align="right">0.150</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">0.25</td>
<td align="right">0.369</td>
<td align="right">0.362</td>
<td align="right">0.355</td>
<td align="right">0.348</td>
<td align="right">0.340</td>
<td align="right">0.334</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">0.50</td>
<td align="right">0.632</td>
<td align="right">0.623</td>
<td align="right">0.615</td>
<td align="right">0.605</td>
<td align="right">0.594</td>
<td align="right">0.582</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">0.75</td>
<td align="right">0.784</td>
<td align="right">0.775</td>
<td align="right">0.764</td>
<td align="right">0.754</td>
<td align="right">0.742</td>
<td align="right">0.727</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.864</td>
<td align="right">1.00</td>
<td align="right">0.830</td>
<td align="right">0.810</td>
<td align="right">0.791</td>
<td align="right">0.774</td>
<td align="right">0.757</td>
<td align="right">0.733</td>
</tr>
</tbody>
</table>
</div>
<div id="benchmark-simaerep-using-portfolio-performance" class="section level1">
<h1 class="hasAnchor">
<a href="#benchmark-simaerep-using-portfolio-performance" class="anchor"></a>Benchmark simaerep Using Portfolio Performance</h1>
<div id="effect-of-adjusting-visit_med75" class="section level2">
<h2 class="hasAnchor">
<a href="#effect-of-adjusting-visit_med75" class="anchor"></a>Effect of Adjusting visit_med75</h2>
<p>One of the latest update to simaerep was an improvement to the visit_med75 calculation. We can check how this has affected portfolio performance. We find that we have most likely slightly increased performance.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_scen_old_visit_med75</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ur_scenarios.html">sim_ur_scenarios</a></span><span class="op">(</span><span class="va">df_portf</span>,
                                           extra_ur_sites <span class="op">=</span> <span class="fl">5</span>,
                                           ur_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>,
                                           parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                           poisson <span class="op">=</span> <span class="cn">TRUE</span>,
                                           prob_lower <span class="op">=</span> <span class="cn">TRUE</span>,
                                           progress <span class="op">=</span> <span class="cn">TRUE</span>,
                                           site_aggr_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"med75"</span><span class="op">)</span><span class="op">)</span> <span class="co"># default is "med75_adj"</span>

<span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">df_scen_old_visit_med75</span>, file <span class="op">=</span> <span class="st">"scen_old.csv"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_scen_old_visit_med75</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"scen_old.csv"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   study_id = col_character(),
##   site_number = col_character(),
##   n_pat = col_double(),
##   n_pat_with_med75 = col_double(),
##   visit_med75 = col_double(),
##   mean_ae_site_med75 = col_double(),
##   mean_ae_study_med75 = col_double(),
##   n_pat_with_med75_study = col_double(),
##   extra_ur_sites = col_double(),
##   frac_pat_with_ur = col_double(),
##   ur_rate = col_double(),
##   pval = col_double(),
##   prob_low = col_double(),
##   pval_adj = col_double(),
##   pval_prob_ur = col_double(),
##   prob_low_adj = col_double(),
##   prob_low_prob_ur = col_double()
## )</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_perf_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_portf_perf.html">get_portf_perf</a></span><span class="op">(</span><span class="va">df_scen_old_visit_med75</span><span class="op">)</span>

<span class="va">df_perf_old</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">extra_ur_sites</span>,
    values_from <span class="op">=</span> <span class="va">tpr</span>,
    names_prefix <span class="op">=</span> <span class="st">"extra_ur_sites_"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="4%">
<col width="5%">
<col width="6%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="right">fpr</th>
<th align="right">thresh</th>
<th align="right">ur_rate</th>
<th align="right">extra_ur_sites_0</th>
<th align="right">extra_ur_sites_1</th>
<th align="right">extra_ur_sites_2</th>
<th align="right">extra_ur_sites_3</th>
<th align="right">extra_ur_sites_4</th>
<th align="right">extra_ur_sites_5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.00</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.10</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
<td align="right">0.006</td>
<td align="right">0.005</td>
<td align="right">0.005</td>
<td align="right">0.005</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.25</td>
<td align="right">0.059</td>
<td align="right">0.056</td>
<td align="right">0.053</td>
<td align="right">0.051</td>
<td align="right">0.048</td>
<td align="right">0.046</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.50</td>
<td align="right">0.264</td>
<td align="right">0.250</td>
<td align="right">0.238</td>
<td align="right">0.227</td>
<td align="right">0.216</td>
<td align="right">0.205</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.75</td>
<td align="right">0.473</td>
<td align="right">0.440</td>
<td align="right">0.423</td>
<td align="right">0.407</td>
<td align="right">0.391</td>
<td align="right">0.375</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">1.00</td>
<td align="right">0.588</td>
<td align="right">0.515</td>
<td align="right">0.491</td>
<td align="right">0.477</td>
<td align="right">0.459</td>
<td align="right">0.433</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.00</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.10</td>
<td align="right">0.048</td>
<td align="right">0.047</td>
<td align="right">0.046</td>
<td align="right">0.045</td>
<td align="right">0.044</td>
<td align="right">0.044</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.25</td>
<td align="right">0.178</td>
<td align="right">0.173</td>
<td align="right">0.166</td>
<td align="right">0.159</td>
<td align="right">0.154</td>
<td align="right">0.149</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.50</td>
<td align="right">0.433</td>
<td align="right">0.421</td>
<td align="right">0.409</td>
<td align="right">0.398</td>
<td align="right">0.387</td>
<td align="right">0.375</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">0.75</td>
<td align="right">0.635</td>
<td align="right">0.615</td>
<td align="right">0.598</td>
<td align="right">0.580</td>
<td align="right">0.565</td>
<td align="right">0.549</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.954</td>
<td align="right">1.00</td>
<td align="right">0.722</td>
<td align="right">0.676</td>
<td align="right">0.645</td>
<td align="right">0.606</td>
<td align="right">0.586</td>
<td align="right">0.569</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">0.00</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">0.10</td>
<td align="right">0.153</td>
<td align="right">0.151</td>
<td align="right">0.148</td>
<td align="right">0.146</td>
<td align="right">0.144</td>
<td align="right">0.142</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">0.25</td>
<td align="right">0.339</td>
<td align="right">0.332</td>
<td align="right">0.327</td>
<td align="right">0.321</td>
<td align="right">0.315</td>
<td align="right">0.309</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">0.50</td>
<td align="right">0.589</td>
<td align="right">0.581</td>
<td align="right">0.573</td>
<td align="right">0.565</td>
<td align="right">0.556</td>
<td align="right">0.547</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">0.75</td>
<td align="right">0.753</td>
<td align="right">0.745</td>
<td align="right">0.737</td>
<td align="right">0.726</td>
<td align="right">0.716</td>
<td align="right">0.706</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.855</td>
<td align="right">1.00</td>
<td align="right">0.804</td>
<td align="right">0.789</td>
<td align="right">0.773</td>
<td align="right">0.757</td>
<td align="right">0.740</td>
<td align="right">0.722</td>
</tr>
</tbody>
</table>
</div>
<div id="days-vs--visits" class="section level2">
<h2 class="hasAnchor">
<a href="#days-vs--visits" class="anchor"></a>Days vs. Visits</h2>
<p>The maximum number of days per patient can be up to several years, so &gt; 1000 days. simaerep exposes implicitly missing entries which can lead to single patients having 1000 entries or more, one entry for each day on the study. In order to avoid to generate a huge portfolio data frame we preserve memory by wrapping <code><a href="../reference/sim_test_data_portfolio.html">sim_test_data_portfolio()</a></code> and <code><a href="../reference/sim_ur_scenarios.html">sim_ur_scenarios()</a></code> into a single call and apply it per study.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df_portf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_test_data_portfolio.html">sim_test_data_portfolio</a></span><span class="op">(</span><span class="va">df</span>, parallel <span class="op">=</span> <span class="cn">FALSE</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">df_scen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_ur_scenarios.html">sim_ur_scenarios</a></span><span class="op">(</span><span class="va">df_portf</span>,
                               extra_ur_sites <span class="op">=</span> <span class="fl">5</span>,
                               ur_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>,
                               parallel <span class="op">=</span> <span class="cn">FALSE</span>,
                               poisson <span class="op">=</span> <span class="cn">TRUE</span>,
                               prob_lower <span class="op">=</span> <span class="cn">TRUE</span>,
                               progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_scen</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">df_prep</span> <span class="op">&lt;-</span> <span class="va">df_config</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span> <span class="va">max_visit_sd</span>, <span class="op">-</span> <span class="va">max_visit_mean</span>, <span class="op">-</span> <span class="va">ae_per_visit_mean</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>max_visit_sd <span class="op">=</span> <span class="va">max_days_sd</span>,
         max_visit_mean <span class="op">=</span> <span class="va">max_days_mean</span>,
         ae_per_visit_mean <span class="op">=</span> <span class="va">ae_per_day_mean</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span>study_id_gr <span class="op">=</span> <span class="va">study_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">nest</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> 

<span class="fu">progressr</span><span class="fu">::</span><span class="fu"><a href="https://progressr.futureverse.org/reference/with_progress.html">with_progress</a></span><span class="op">(</span>
  <span class="va">df_scen_days</span> <span class="op">&lt;-</span> <span class="va">df_prep</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="../reference/purrr_bar.html">purrr_bar</a></span><span class="op">(</span>
      <span class="va">.data</span><span class="op">$</span><span class="va">data</span>,
      .purrr <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span>,
      .f <span class="op">=</span> <span class="va">wr</span>,
      .progress <span class="op">=</span> <span class="cn">TRUE</span>,
      .steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,
      .purrr_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span>
   <span class="op">)</span>
<span class="op">)</span>

<span class="va">df_scen_days</span> <span class="op">&lt;-</span> <span class="va">df_scen_days</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span> <span class="va">study_id_gr</span><span class="op">)</span>

<span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">df_scen_days</span>, file <span class="op">=</span> <span class="st">"scen_days.csv"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_scen_days</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"scen_days.csv"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   study_id = col_character(),
##   site_number = col_character(),
##   n_pat = col_double(),
##   n_pat_with_med75 = col_double(),
##   visit_med75 = col_double(),
##   mean_ae_site_med75 = col_double(),
##   mean_ae_study_med75 = col_double(),
##   n_pat_with_med75_study = col_double(),
##   extra_ur_sites = col_double(),
##   frac_pat_with_ur = col_double(),
##   ur_rate = col_double(),
##   pval = col_double(),
##   prob_low = col_double(),
##   pval_adj = col_double(),
##   pval_prob_ur = col_double(),
##   prob_low_adj = col_double(),
##   prob_low_prob_ur = col_double()
## )</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_perf_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_portf_perf.html">get_portf_perf</a></span><span class="op">(</span><span class="va">df_scen_days</span><span class="op">)</span>

<span class="va">df_perf_days</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">extra_ur_sites</span>,
    values_from <span class="op">=</span> <span class="va">tpr</span>,
    names_prefix <span class="op">=</span> <span class="st">"extra_ur_sites_"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="4%">
<col width="5%">
<col width="6%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="right">fpr</th>
<th align="right">thresh</th>
<th align="right">ur_rate</th>
<th align="right">extra_ur_sites_0</th>
<th align="right">extra_ur_sites_1</th>
<th align="right">extra_ur_sites_2</th>
<th align="right">extra_ur_sites_3</th>
<th align="right">extra_ur_sites_4</th>
<th align="right">extra_ur_sites_5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.00</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
<td align="right">0.001</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.10</td>
<td align="right">0.013</td>
<td align="right">0.012</td>
<td align="right">0.011</td>
<td align="right">0.011</td>
<td align="right">0.010</td>
<td align="right">0.009</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.25</td>
<td align="right">0.115</td>
<td align="right">0.107</td>
<td align="right">0.100</td>
<td align="right">0.093</td>
<td align="right">0.087</td>
<td align="right">0.082</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.50</td>
<td align="right">0.341</td>
<td align="right">0.310</td>
<td align="right">0.288</td>
<td align="right">0.273</td>
<td align="right">0.258</td>
<td align="right">0.245</td>
</tr>
<tr class="odd">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">0.75</td>
<td align="right">0.496</td>
<td align="right">0.443</td>
<td align="right">0.408</td>
<td align="right">0.390</td>
<td align="right">0.371</td>
<td align="right">0.351</td>
</tr>
<tr class="even">
<td align="right">0.001</td>
<td align="right">0.995</td>
<td align="right">1.00</td>
<td align="right">0.568</td>
<td align="right">0.469</td>
<td align="right">0.429</td>
<td align="right">0.414</td>
<td align="right">0.396</td>
<td align="right">0.372</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">0.00</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
<td align="right">0.010</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">0.10</td>
<td align="right">0.064</td>
<td align="right">0.062</td>
<td align="right">0.059</td>
<td align="right">0.057</td>
<td align="right">0.055</td>
<td align="right">0.053</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">0.25</td>
<td align="right">0.243</td>
<td align="right">0.233</td>
<td align="right">0.224</td>
<td align="right">0.215</td>
<td align="right">0.207</td>
<td align="right">0.198</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">0.50</td>
<td align="right">0.492</td>
<td align="right">0.472</td>
<td align="right">0.453</td>
<td align="right">0.435</td>
<td align="right">0.417</td>
<td align="right">0.402</td>
</tr>
<tr class="odd">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">0.75</td>
<td align="right">0.648</td>
<td align="right">0.613</td>
<td align="right">0.585</td>
<td align="right">0.559</td>
<td align="right">0.534</td>
<td align="right">0.517</td>
</tr>
<tr class="even">
<td align="right">0.010</td>
<td align="right">0.957</td>
<td align="right">1.00</td>
<td align="right">0.707</td>
<td align="right">0.638</td>
<td align="right">0.581</td>
<td align="right">0.542</td>
<td align="right">0.517</td>
<td align="right">0.498</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">0.00</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
<td align="right">0.050</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">0.10</td>
<td align="right">0.181</td>
<td align="right">0.178</td>
<td align="right">0.175</td>
<td align="right">0.171</td>
<td align="right">0.169</td>
<td align="right">0.165</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">0.25</td>
<td align="right">0.405</td>
<td align="right">0.396</td>
<td align="right">0.387</td>
<td align="right">0.380</td>
<td align="right">0.372</td>
<td align="right">0.361</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">0.50</td>
<td align="right">0.628</td>
<td align="right">0.617</td>
<td align="right">0.605</td>
<td align="right">0.594</td>
<td align="right">0.582</td>
<td align="right">0.569</td>
</tr>
<tr class="odd">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">0.75</td>
<td align="right">0.748</td>
<td align="right">0.737</td>
<td align="right">0.724</td>
<td align="right">0.714</td>
<td align="right">0.701</td>
<td align="right">0.685</td>
</tr>
<tr class="even">
<td align="right">0.050</td>
<td align="right">0.857</td>
<td align="right">1.00</td>
<td align="right">0.783</td>
<td align="right">0.759</td>
<td align="right">0.737</td>
<td align="right">0.718</td>
<td align="right">0.695</td>
<td align="right">0.669</td>
</tr>
</tbody>
</table>
</div>
<div id="plot" class="section level2">
<h2 class="hasAnchor">
<a href="#plot" class="anchor"></a>Plot</h2>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_perf</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"med75_adj"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">bind_rows</span><span class="op">(</span>
    <span class="va">df_perf_old</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"med75"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">bind_rows</span><span class="op">(</span>
    <span class="va">df_perf_days</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fpr</span>, y <span class="op">=</span> <span class="va">tpr</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">facet_grid</span><span class="op">(</span><span class="va">ur_rate</span> <span class="op">~</span> <span class="va">extra_ur_sites</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<p><img src="portfolio_perf_files/figure-html/plot-1.png" width="1152"></p>
<p>Using days instead of visits does not provide a clear advantage while the adjusted method for determining the evaluation point visit_med75 seems to be advantageous.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
