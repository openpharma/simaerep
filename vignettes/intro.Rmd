---
title: "Introduction"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show
    collapse: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

# Load
```{r}
suppressPackageStartupMessages( library(tidyverse) )
suppressPackageStartupMessages( library(knitr) )
suppressPackageStartupMessages( library(simaerep) )
```

# Introduction

Simulate adverse event reporting in clinical trials with the goal of detecting under-reporting sites.

Monitoring of Adverse Event (AE) reporting in clinical trials is important for patient safety. We
use bootstrap-based simulation to assign an AE under-reporting probability to each site in a clinical trial.
The method is inspired by the 'infer' R package and Alen Downey's blog article: ["There is only one test!"](
http://allendowney.blogspot.com/2011/05/there-is-only-one-test.html).

## Adverse Events

An adverse event (AE) is any untoward medical occurrence in a patient or clinical investigation subject administered a pharmaceutical product and which does not necessarily have a causal relationship with this treatment. It is important for patient safety that AEs are reported back to the sponsor. An important part of quality monitoring is to detect clinical trial sites that are not propagating all of the AEs reported to them by their patients to the sponsor. In a clinical trial patients follow a strict visiting schedule at which times treatments are given and exams are being performed. Typically AEs get reported by a patient when they are at an on-site visit at the clinic. So the total number of AEs reported by a site depends on the number of patients enrolled at the site and the total number of visits. 

## Algorithm

In a nutshell we will perform the following steps.

1) Record visit_med75, number of patients that have reached visit_med75, mean cumulative AE count at visit_med75 for a clinical trial site.
2) Create patient pool with all patients in study that have reached visit_med75 as determined in 1) and their cumulative AE count at visit_med75.
3) Draw with replacement as many patients from 2) as determined in 1) and calculate the mean cumulative AE count of the draw (figure 1b).
4) Repeat 3) 1000 times.
5) Calculate probability of obtaining mean cumulative AE count or lower as obtained in 1) based on results of 4).
6) Repeat 1-5) for all sites in trial
7) For a probability determined in 6) calculate expected false positive rate (FP) as probability * number of clinical trial sites.
8) For a probability determined in 5) calculate all positives (p) as the count of sites with the same probability or lower.
9) Calculate AE under-reporting probability for all sites  as 1 - FP/p with results from 7-8)



## Sample Data

### Patient

Patient level AE data is characterised by the number of consecutive visits and the number of AEs that have been reported each time. For the maximum consecutive visit we sample from a normal distribution and for the AEs reported at each visit we sample from a poisson distribution.

Here we simulate the AEs generated by 3 patients

```{r}

set.seed(1)

replicate(
   3,
   sim_test_data_patient(
    .f_sample_max_visit = function() rnorm(1, mean = 20, sd = 4),
    .f_sample_ae_per_visit = function(max_visit) rpois(max_visit, 0.5)
  )
)

```

### Study

In order to simulate patient data for an entire study we assume make the simplification that all sites have the same number of patients. Further we specify a fraction of sites that is under-reporting AEs

```{r}
df_visit <- sim_test_data_study(
  n_pat = 120,
  n_sites = 6,
  frac_site_with_ur = 0.4,
  ur_rate = 0.6,
  max_visit_mean = 20,
  max_visit_sd = 4,
  ae_per_visit_mean = 0.5
)

df_visit

df_visit %>%
  select(site_number, is_ur) %>%
  distinct()
```

In our sample data 2 sites (S0001 and S0002) are under-reporting AEs

## Specifying the Evaluation Point visit_med75

In an ongoing trial all patients will have a different number of consecutive visits. To find a cut-off visit to normalize the data we specify a single evaluation point for a given site based on the number of visits of the patient population. We take the median of the maximum visit of all the patients and multiply by 0.75 (visit_med75). For this we use `site_aggr` to aggregate the simulated visit level data to site level.

```{r}

df_visit$study_id <- "A"
df_site <- site_aggr(df_visit)

df_site

plot_visit_med75(df_visit, df_site, study_id_str = "A", n_site = 6)
```

Using the visit_med75 will drop a few patients (dashed lines) but will by definietion at least include 50% of all patients favouring patients that have higher number of visits. By looking at the mean ae development (purple line) we can already easily spot the two under-reporting sites. Same goes for looking at the `mean_ae_site_med75` column in `df_site`. Next we will use bootstrap simulations to determine the probability for obtaining each mean ae value or lower at visit_med75 by chance.

## Bootstrap Simulations

### Advantage Over Classic Statistical Tests

We could use a classical parametric test and calculate the probability with which we can reject the NULL hypothesis for the AE counts that we observe at the visit_med75.

As we sample the AEs from a poisson distribution the R implementation of the poisson.test would be appropriate.

But there are four major problems that we often encounter when we try to describe real life count data with the poisson distribution which is only described by a single parameter:

- over and underdispersion
- skewness (long right tail)
- inflated zeros
- variance mean relationship might not be fixed

(see [Distiributuion for Modelling Location Scale and Shape 5.1.2](https://www.gamlss.com/wp-content/uploads/2018/01/DistributionsForModellingLocationScaleandShape.pdf))

The true distribution of the AE counts will vary from study to study with the degree of the influence of these 4 problems being unknown unless thoroughly investigated.

With the non-parametric approach that we propose we do not need to worry about these statistical assumptions. Since the distribution of the AE count from the simulated patient pool we draw from will be very close to the unknown true distribution of the underlying AE generating process.


### Disadvantages Over Classic Statistical Tests

- The number of repeats determines the smallest probability greater than zero, for example a for r=1000 the smalles value greater than zero is 0.001
- Computationally more expensive


### Methodology

*How likely is it to get a mean AE value that is equal or lower to what we observe at site C with the same number of patients?*

For illustration purposes we start to simulate 10 hypothetical patient groups for site C by drawing (with replacement) from all patients in the study marking those for which we have obtained an equal or lower mean AE value than initially observed (middle).


Instead of 10 times we simulate 1000 times and count how many times we have observed an equal or lower mean AE value than initially observed and convert it to a percentage (right).

To illustrate the effect of under-reporting we repeat the same process after having removed 2 AEs per patient from site C. We see how the probability for obtaining an equal or lower mean AE value than initially observed decreases (bottom).

```{r fig.width=10, fig.height=7}
plot_sim_examples(size_dot = 3, size_raster_label = 10)
```

### Application

We can run the above described simulation and as a becnhmark also perform a poisson test.

```{r}
df_sim_sites <- sim_sites(df_site, df_visit, r = 1000, poisson_test = TRUE)
df_sim_sites
```

We find that the probability of getting a mean ae at visit_med75 for sites S0001 and S0002 is 0 or near zero.

## Alpha Error Correction

Our simulated test data set consists of just 6 sites. However, it is not uncommon for 100 sites or more to participate in the same clinical trial. This would mean that we neeed to perform 100 statistical tests, and applying a 5% significance threshold would lead to on average of 5 False Positives (FP). We therefore need to account for the number of expected FP when we are calculating the true under-reporting probability.

- For a given simulated probability calculate expected FP as probability * number of clinical trial sites.
- For a given simulated probability calculate the number of positives (P) as the count of sites with the same probability or lower.
- Calcutate the P/FP ratio
- Express underreporting probability as 1 - FP/P

```{r}
df_eval <- eval_sites(df_sim_sites,
                      r_sim_sites = 1000 #needs to be passed to in order to consider smallest value > 0
                      )
df_eval
```

the colummn `prob_low_p_vs_fp_ratio` contains the P/FP ratio. A ratio of 20 represents ~ 95 % probability of under-reporting (20/21) which we consider a sensible threshold.

## Plot Results

`plot_study` will plot mean ae development of all sites and visit level data for each flagged site using a P/FP threshold of 20

```{r}
plot_study(df_visit, df_site, df_eval, study = "A")
```



